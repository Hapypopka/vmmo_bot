{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - VMMO Bot Panel{% endblock %}

{% block content %}
<div class="stats-header mb-2">
    <h1 class="page-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</h1>
    <div class="stats-filters">
        <select id="profileSelect" class="form-select" onchange="saveFiltersAndLoad()">
            <option value="all">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
            {% for profile, name in profiles.items() %}
            <option value="{{ profile }}">{{ name }}</option>
            {% endfor %}
        </select>
        <select id="periodSelect" class="form-select" onchange="saveFiltersAndLoad()">
            <option value="day">–ó–∞ –¥–µ–Ω—å</option>
            <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
            <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
        </select>
        <select id="modeSelect" class="form-select" onchange="saveFiltersAndLoad()">
            <option value="sessions">–ü–æ —Å–µ—Å—Å–∏—è–º</option>
            <option value="days">–ü–æ –¥–Ω—è–º</option>
        </select>
    </div>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
<div class="card mb-2">
    <div class="flex gap-1 flex-wrap">
        <label class="resource-toggle active" data-resource="–∑–æ–ª–æ—Ç–æ">
            <img src="{{ url_for('static', filename='icons/money_gold.png') }}" class="res-icon-sm">
            <span>–ó–æ–ª–æ—Ç–æ</span>
        </label>
        <label class="resource-toggle active" data-resource="—Å–µ—Ä–µ–±—Ä–æ">
            <img src="{{ url_for('static', filename='icons/money_silver.png') }}" class="res-icon-sm">
            <span>–°–µ—Ä–µ–±—Ä–æ</span>
        </label>
        <label class="resource-toggle" data-resource="—á–µ—Ä–µ–ø–∞">
            <img src="{{ url_for('static', filename='icons/skull.png') }}" class="res-icon-sm">
            <span>–ß–µ—Ä–µ–ø–∞</span>
        </label>
        <label class="resource-toggle" data-resource="–º–∏–Ω–µ—Ä–∞–ª—ã">
            <img src="{{ url_for('static', filename='icons/mineral.png') }}" class="res-icon-sm">
            <span>–ú–∏–Ω–µ—Ä–∞–ª—ã</span>
        </label>
        <label class="resource-toggle" data-resource="—Å–∞–ø—Ñ–∏—Ä—ã">
            <img src="{{ url_for('static', filename='icons/sapphire.png') }}" class="res-icon-sm">
            <span>–°–∞–ø—Ñ–∏—Ä—ã</span>
        </label>
        <label class="resource-toggle" data-resource="—Ä—É–±–∏–Ω—ã">
            <img src="{{ url_for('static', filename='icons/ruby.png') }}" class="res-icon-sm">
            <span>–†—É–±–∏–Ω—ã</span>
        </label>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="card mb-2">
    <div class="chart-header">
        <h3 class="card-title">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
        <div class="chart-mode-toggle">
            <button class="chart-mode-btn active" data-chart-mode="balance">üìà –ë–∞–ª–∞–Ω—Å</button>
            <button class="chart-mode-btn" data-chart-mode="earnings">üìä –ó–∞—Ä–∞–±–æ—Ç–æ–∫</button>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="resourceChart"></canvas>
    </div>
    <div id="noDataMessage" class="text-muted text-center" style="display: none; padding: 3rem;">
        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –î–∞–Ω–Ω—ã–µ –Ω–∞—á–Ω—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–æ–≤.
    </div>
</div>

<!-- –ò—Ç–æ–≥–∏ -->
<div class="card mt-2">
    <h3 class="card-title">–ò—Ç–æ–≥–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
    <div id="summaryStats" class="summary-grid">
        <div class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<!-- –¢–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã -->
<h2 class="mt-2 mb-1 section-title">–¢–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã</h2>
<div class="card">
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>–ü–µ—Ä—Å–æ–Ω–∞–∂</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th class="text-right"><img src="{{ url_for('static', filename='icons/money_gold.png') }}" class="th-icon"> –ó–æ–ª–æ—Ç–æ</th>
                    <th class="text-right"><img src="{{ url_for('static', filename='icons/skull.png') }}" class="th-icon"> –ß–µ—Ä–µ–ø–∞</th>
                    <th class="text-right"><img src="{{ url_for('static', filename='icons/mineral.png') }}" class="th-icon"> –ú–∏–Ω–µ—Ä–∞–ª—ã</th>
                    <th class="text-right"><img src="{{ url_for('static', filename='icons/sapphire.png') }}" class="th-icon"> –°–∞–ø—Ñ–∏—Ä—ã</th>
                    <th class="text-right"><img src="{{ url_for('static', filename='icons/ruby.png') }}" class="th-icon"> –†—É–±–∏–Ω—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for bot in stats %}
                <tr>
                    <td><strong>{{ bot.name }}</strong></td>
                    <td>
                        <span class="status status-{{ bot.status }}">
                            <span class="status-dot"></span>
                            {{ '–†–∞–±–æ—Ç–∞–µ—Ç' if bot.status == 'running' else '–°—Ç–æ–ø' }}
                        </span>
                    </td>
                    <td class="text-right">
                        <span class="text-gold">{{ bot.resources.get('–∑–æ–ª–æ—Ç–æ', 0) }}</span>
                        {% if bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) != 0 %}
                        <br><small class="{{ 'text-success' if bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) > 0 else 'text-danger' }}">
                            {{ '%+d' % bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) }}
                        </small>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {{ bot.resources.get('—á–µ—Ä–µ–ø–∞', 0) }}
                        {% if bot.earned.get('—á–µ—Ä–µ–ø–∞', 0) != 0 %}
                        <br><small class="{{ 'text-success' if bot.earned.get('—á–µ—Ä–µ–ø–∞', 0) > 0 else 'text-danger' }}">
                            {{ '%+d' % bot.earned.get('—á–µ—Ä–µ–ø–∞', 0) }}
                        </small>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {{ bot.resources.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}
                        {% if bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) != 0 %}
                        <br><small class="{{ 'text-success' if bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) > 0 else 'text-danger' }}">
                            {{ '%+d' % bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}
                        </small>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {{ bot.resources.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}
                        {% if bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) != 0 %}
                        <br><small class="{{ 'text-success' if bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) > 0 else 'text-danger' }}">
                            {{ '%+d' % bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}
                        </small>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {{ bot.resources.get('—Ä—É–±–∏–Ω—ã', 0) }}
                        {% if bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) != 0 %}
                        <br><small class="{{ 'text-success' if bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) > 0 else 'text-danger' }}">
                            {{ '%+d' % bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) }}
                        </small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Terminal OS ‚Äî stats overrides */
    .stats-header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .stats-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .form-select {
        width: auto;
        min-width: 120px;
        flex: 1;
    }

    @media (min-width: 769px) {
        .stats-header { flex-direction: row; justify-content: space-between; align-items: center; }
        .stats-filters { flex-wrap: nowrap; }
        .form-select { flex: none; min-width: 140px; }
    }

    .resource-toggle {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border: 1px solid var(--border);
        cursor: pointer;
        transition: border-color 0.15s;
        user-select: none;
        font-size: 12px;
    }

    .resource-toggle:hover { border-color: var(--border-active); }

    .resource-toggle.active {
        border-color: var(--green);
        color: var(--green);
    }

    .res-icon-sm { width: 14px; height: 14px; }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .chart-header .card-title { margin: 0; }

    .chart-mode-toggle {
        display: flex;
        gap: 2px;
        border: 1px solid var(--border);
        padding: 2px;
    }

    .chart-mode-btn {
        padding: 0.3rem 0.6rem;
        border: none;
        background: transparent;
        color: var(--text-3);
        cursor: pointer;
        font-size: 11px;
        font-family: inherit;
        transition: color 0.1s, background 0.1s;
        white-space: nowrap;
    }

    .chart-mode-btn:hover { color: var(--text); }

    .chart-mode-btn.active {
        background: var(--green);
        color: #000;
    }

    .chart-container { position: relative; height: 400px; width: 100%; }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 0.5rem;
    }

    .summary-item {
        text-align: center;
        padding: 0.75rem;
        border: 1px solid var(--border);
    }

    .summary-item:hover { border-color: var(--border-active); }

    .summary-item img { width: 24px; height: 24px; margin-bottom: 0.375rem; }

    .summary-value { font-size: 16px; font-weight: 700; }
    .summary-value.positive { color: var(--green); }
    .summary-value.negative { color: var(--red); }

    .summary-label { font-size: 11px; color: var(--text-3); margin-top: 0.25rem; }

    .th-icon { width: 14px; height: 14px; vertical-align: middle; margin-right: 0.25rem; }

    @media (max-width: 768px) {
        .chart-container { height: 300px; }
    }
</style>

<script>
    let chart = null;
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage
    let activeResources = JSON.parse(localStorage.getItem('statsActiveResources')) || ['–∑–æ–ª–æ—Ç–æ', '—Å–µ—Ä–µ–±—Ä–æ'];
    const savedFilters = JSON.parse(localStorage.getItem('statsFilters')) || {};
    let chartData = null;
    let chartMode = localStorage.getItem('statsChartMode') || 'balance'; // balance –∏–ª–∏ earnings

    // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
    function restoreUIState() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const profileSelect = document.getElementById('profileSelect');
        const periodSelect = document.getElementById('periodSelect');
        const modeSelect = document.getElementById('modeSelect');

        if (savedFilters.profile && profileSelect) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–∫–æ–π option —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            const option = profileSelect.querySelector(`option[value="${savedFilters.profile}"]`);
            if (option) {
                profileSelect.value = savedFilters.profile;
            }
        }

        if (savedFilters.period && periodSelect) {
            periodSelect.value = savedFilters.period;
        } else if (periodSelect) {
            periodSelect.value = 'week'; // –¥–µ—Ñ–æ–ª—Ç
        }

        if (savedFilters.mode && modeSelect) {
            modeSelect.value = savedFilters.mode;
        } else if (modeSelect) {
            modeSelect.value = 'sessions'; // –¥–µ—Ñ–æ–ª—Ç
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º toggles —Ä–µ—Å—É—Ä—Å–æ–≤
        document.querySelectorAll('.resource-toggle').forEach(toggle => {
            const resource = toggle.dataset.resource;
            if (activeResources.includes(resource)) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –≥—Ä–∞—Ñ–∏–∫–∞
        document.querySelectorAll('.chart-mode-btn').forEach(btn => {
            if (btn.dataset.chartMode === chartMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    document.querySelectorAll('.chart-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            chartMode = btn.dataset.chartMode;
            localStorage.setItem('statsChartMode', chartMode);

            document.querySelectorAll('.chart-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            loadStats();
        });
    });

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', () => {
        restoreUIState();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ü–û–°–õ–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è UI
        loadStats();
    });

    function saveFiltersAndLoad() {
        const filters = {
            profile: document.getElementById('profileSelect').value,
            period: document.getElementById('periodSelect').value,
            mode: document.getElementById('modeSelect').value
        };
        localStorage.setItem('statsFilters', JSON.stringify(filters));
        loadStats();
    }

    const resourceColors = {
        '–∑–æ–ª–æ—Ç–æ': { line: '#fbbf24', bg: 'rgba(251, 191, 36, 0.1)' },
        '—Å–µ—Ä–µ–±—Ä–æ': { line: '#94a3b8', bg: 'rgba(148, 163, 184, 0.1)' },
        '—á–µ—Ä–µ–ø–∞': { line: '#a78bfa', bg: 'rgba(167, 139, 250, 0.1)' },
        '–º–∏–Ω–µ—Ä–∞–ª—ã': { line: '#34d399', bg: 'rgba(52, 211, 153, 0.1)' },
        '—Å–∞–ø—Ñ–∏—Ä—ã': { line: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
        '—Ä—É–±–∏–Ω—ã': { line: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }
    };

    const resourceIcons = {
        '–∑–æ–ª–æ—Ç–æ': 'money_gold.png',
        '—Å–µ—Ä–µ–±—Ä–æ': 'money_silver.png',
        '—á–µ—Ä–µ–ø–∞': 'skull.png',
        '–º–∏–Ω–µ—Ä–∞–ª—ã': 'mineral.png',
        '—Å–∞–ø—Ñ–∏—Ä—ã': 'sapphire.png',
        '—Ä—É–±–∏–Ω—ã': 'ruby.png'
    };

    // Toggle resource visibility
    document.querySelectorAll('.resource-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const resource = toggle.dataset.resource;
            toggle.classList.toggle('active');

            if (toggle.classList.contains('active')) {
                if (!activeResources.includes(resource)) {
                    activeResources.push(resource);
                }
            } else {
                activeResources = activeResources.filter(r => r !== resource);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('statsActiveResources', JSON.stringify(activeResources));

            updateChart();
        });
    });

    async function loadStats() {
        const profile = document.getElementById('profileSelect').value;
        const period = document.getElementById('periodSelect').value;
        const mode = document.getElementById('modeSelect').value;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º API: –¥–ª—è earnings –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º earnings, –∏–Ω–∞—á–µ mode –∏–∑ —Å–µ–ª–µ–∫—Ç–∞
        const apiMode = chartMode === 'earnings' ? 'earnings' : mode;

        try {
            // Load chart data
            const chartResp = await apiCall(`/api/stats/chart/${profile}?period=${period}&mode=${apiMode}`);
            if (chartResp.success) {
                chartData = chartResp.data;
                chartData.mode = mode;  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º —Å–µ–ª–µ–∫—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç
                chartData.chartMode = chartMode;  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –≥—Ä–∞—Ñ–∏–∫–∞
                updateChart();
            }

            // Load summary
            const summaryResp = await apiCall(`/api/stats/summary/${profile}?period=${period}`);
            if (summaryResp.success) {
                renderSummary(summaryResp.summary);
            }

        } catch (e) {
            console.error('Error loading stats:', e);
        }
    }

    function updateChart() {
        const chartContainer = document.querySelector('.chart-container');
        const noDataMsg = document.getElementById('noDataMessage');

        if (!chartData || !chartData.timestamps || chartData.timestamps.length === 0) {
            chartContainer.style.display = 'none';
            noDataMsg.style.display = 'block';
            if (chart) {
                chart.destroy();
                chart = null;
            }
            return;
        }

        chartContainer.style.display = 'block';
        noDataMsg.style.display = 'none';

        const isEarningsMode = chartData.chartMode === 'earnings';
        const datasets = [];

        for (const resource of activeResources) {
            if (chartData.resources[resource]) {
                if (isEarningsMode) {
                    // –î–ª—è —Ä–µ–∂–∏–º–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ - bar chart —Å —Ü–≤–µ—Ç–∞–º–∏ –ø–æ –∑–Ω–∞–∫—É
                    const data = chartData.resources[resource];
                    const bgColors = data.map(v => v >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)');
                    const borderColors = data.map(v => v >= 0 ? '#22c55e' : '#ef4444');

                    datasets.push({
                        label: resource.charAt(0).toUpperCase() + resource.slice(1),
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 4
                    });
                } else {
                    // –î–ª—è —Ä–µ–∂–∏–º–∞ –±–∞–ª–∞–Ω—Å–∞ - line chart
                    datasets.push({
                        label: resource.charAt(0).toUpperCase() + resource.slice(1),
                        data: chartData.resources[resource],
                        borderColor: resourceColors[resource].line,
                        backgroundColor: resourceColors[resource].bg,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    });
                }
            }
        }

        const ctx = document.getElementById('resourceChart').getContext('2d');

        if (chart) {
            chart.destroy();
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º timestamps –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const isDaysMode = chartData.mode === 'days' || isEarningsMode;
        const labels = chartData.timestamps.map(ts => {
            const d = new Date(ts);
            if (isDaysMode) {
                // –î–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ –¥–Ω—è–º" –∏ "–∑–∞—Ä–∞–±–æ—Ç–æ–∫" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
                return d.toLocaleString('ru-RU', {day: '2-digit', month: '2-digit'});
            } else {
                // –î–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ —Å–µ—Å—Å–∏—è–º" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                return d.toLocaleString('ru-RU', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
            }
        });

        chart = new Chart(ctx, {
            type: isEarningsMode ? 'bar' : 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e2e8f0'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context[0].dataIndex;
                                const ts = chartData.timestamps[idx];
                                return new Date(ts).toLocaleString('ru-RU', {day: '2-digit', month: 'long', year: 'numeric'});
                            },
                            label: function(context) {
                                const value = context.parsed.y;
                                const label = context.dataset.label;
                                if (isEarningsMode) {
                                    const sign = value >= 0 ? '+' : '';
                                    return `${label}: ${sign}${value.toLocaleString('ru-RU')}`;
                                }
                                return `${label}: ${value.toLocaleString('ru-RU')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 45,
                            maxTicksLimit: 12
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                if (isEarningsMode && value > 0) {
                                    return '+' + value.toLocaleString('ru-RU');
                                }
                                return value.toLocaleString('ru-RU');
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    function renderSummary(summary) {
        const container = document.getElementById('summaryStats');

        if (!summary) {
            container.innerHTML = '<div class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>';
            return;
        }

        const resources = ['–∑–æ–ª–æ—Ç–æ', '—Å–µ—Ä–µ–±—Ä–æ', '—á–µ—Ä–µ–ø–∞', '–º–∏–Ω–µ—Ä–∞–ª—ã', '—Å–∞–ø—Ñ–∏—Ä—ã', '—Ä—É–±–∏–Ω—ã'];

        container.innerHTML = resources.map(resource => {
            const value = summary[resource] || 0;
            const cls = value > 0 ? 'positive' : value < 0 ? 'negative' : '';
            const icon = resourceIcons[resource];
            const displayValue = value > 0 ? `+${value.toLocaleString()}` : value.toLocaleString();

            return `
                <div class="summary-item">
                    <img src="/static/icons/${icon}">
                    <div class="summary-value ${cls}">${displayValue}</div>
                    <div class="summary-label">${resource}</div>
                </div>
            `;
        }).join('');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ DOMContentLoaded –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è UI
</script>
{% endblock %}
