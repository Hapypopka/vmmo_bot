{% extends "base.html" %}
{% block title %}–¶–µ–Ω—ã –∫—Ä–∞—Ñ—Ç–∞ - VMMO Bot{% endblock %}

{% block content %}
<div class="page-header flex flex-between flex-center">
    <div>
        <h1 class="page-title">–¶–µ–Ω—ã –∫—Ä–∞—Ñ—Ç–∞</h1>
        <p class="page-subtitle" id="modeDescription">–ü–æ–ª–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–æ—Ñ–∏—Ç–Ω–æ—Å—Ç–∏ "—Å –Ω—É–ª—è" (–º–∏–Ω–µ—Ä–∞–ª—ã ‚Üí –≥–æ—Ç–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç)</p>
    </div>
    <div class="flex gap-1 flex-wrap">
        <select id="profileSelect" class="form-select" style="width: 150px;" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
            {% for profile, name in profiles.items() %}
            <option value="{{ profile }}">{{ name }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary" onclick="loadPrices(true)">
            <span id="loadBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</span>
        </button>
    </div>
</div>

<div id="cacheInfo" class="alert alert-info mb-2" style="display: none;">
    <span class="alert-icon">üíæ</span>
    <span>–î–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (<span id="cacheTime"></span>). –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω.</span>
</div>

<div id="loading" class="card" style="display: none;">
    <div class="text-center" style="padding: 2rem;">
        <div class="btn-loading" style="width: 40px; height: 40px; margin: 0 auto 1rem; border-width: 3px;"></div>
        <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω —Å –∞—É–∫—Ü–∏–æ–Ω–∞...</p>
        <p class="text-muted" style="font-size: 0.8rem;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã</p>
    </div>
</div>

<div id="error" class="alert alert-danger" style="display: none;">
    <span class="alert-icon">!</span>
    <span id="errorText"></span>
</div>

<div id="results" style="display: none;">
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
    <div class="card mb-2">
        <div class="flex flex-between flex-center">
            <div class="flex gap-1">
                <button class="btn btn-sm mode-btn active" id="modeFromScratch" onclick="setMode('scratch')">
                    üî® –° –Ω—É–ª—è
                </button>
                <button class="btn btn-sm btn-dark mode-btn" id="modeBuyComponents" onclick="setMode('buy')">
                    üõí –° –ø–æ–∫—É–ø–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                </button>
            </div>
            <div class="text-muted" style="font-size: 0.8rem;">
                <span id="modeHint">–ö—Ä–∞—Ñ—Ç–∏–º –≤—Å—ë —Å–∞–º–∏ –∏–∑ –º–∏–Ω–µ—Ä–∞–ª–æ–≤</span>
            </div>
        </div>
    </div>

    <!-- –°–≤–æ–¥–∫–∞ –ø—Ä–æ—Ñ–∏—Ç–∞ -->
    <div class="card mb-2">
        <div class="card-title">
            <span class="card-title-icon">üí∞</span>
            <span id="tableTitle">–ü—Ä–æ—Ñ–∏—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞—Ñ—Ç–∞ (—Å –Ω—É–ª—è)</span>
        </div>
        <p class="text-muted mb-2" style="font-size: 0.8rem;" id="tableSubtitle">
            –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –ø—Ä–æ—Ñ–∏—Ç—É –≤ —á–∞—Å. –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –∫—Ä–∞—Ñ—Ç–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
        </p>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>–†–µ—Ü–µ–ø—Ç</th>
                        <th>–ü—Ä–æ–¥–∞–∂–∞</th>
                        <th>–°–µ–±–µ—Å—Ç.</th>
                        <th>–ü—Ä–æ—Ñ–∏—Ç</th>
                        <th>%</th>
                        <th id="thResources">–†–µ—Å—É—Ä—Å—ã</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–∑/—á–∞—Å</th>
                    </tr>
                </thead>
                <tbody id="profitTable"></tbody>
            </table>
        </div>
    </div>

    <!-- –¶–µ–Ω—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
    <div class="card">
        <div class="card-title">
            <span class="card-title-icon">üì¶</span>
            –¶–µ–Ω—ã –±–∞–∑–æ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–∑–∞ 1 —à—Ç)
        </div>
        <div class="grid grid-3" id="pricesGrid"></div>
    </div>
</div>

<style>
    /* Terminal OS ‚Äî craft_prices overrides */
    .profit-positive { color: var(--green); font-weight: 600; }
    .profit-negative { color: var(--red); font-weight: 600; }
    .price-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
    }
    .price-name { font-weight: 500; }
    .price-value { color: var(--amber); font-weight: 600; }
    .time-badge { font-size: 11px; color: var(--text-3); }
    .resource-badge {
        font-size: 11px;
        padding: 1px 4px;
        border: 1px solid var(--border);
        color: var(--text-2);
    }
    .profit-hour { font-weight: 700; font-size: 12px; }
    .profit-hour.positive { color: var(--green); }
    .profit-hour.negative { color: var(--red); }
    .mode-btn.active {
        border-color: var(--green);
        color: var(--green);
    }
    .components-badge { font-size: 10px; color: var(--text-3); display: block; margin-top: 2px; }
</style>

{% endblock %}

{% block scripts %}
<script>
let isLoading = false;
let currentMode = 'scratch';  // 'scratch' –∏–ª–∏ 'buy'
let cachedData = null;  // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∫—ç—à–∞
document.addEventListener('DOMContentLoaded', () => {
    loadFromCache();
});

async function loadFromCache() {
    try {
        const response = await fetch('/api/craft_prices/cached');
        const data = await response.json();

        if (data.success && data.cached) {
            cachedData = data;
            renderResults(data);
            document.getElementById('results').style.display = 'block';
            document.getElementById('cacheInfo').style.display = 'flex';
            document.getElementById('cacheTime').textContent = data.cached_at || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    } catch (e) {
        console.log('No cache available');
    }
}

async function loadPrices(forceRefresh = false) {
    if (isLoading) return;
    isLoading = true;

    const profile = document.getElementById('profileSelect').value;
    const loadBtn = document.getElementById('loadBtn');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const results = document.getElementById('results');
    const cacheInfo = document.getElementById('cacheInfo');

    loadBtn.innerHTML = '<span class="btn-loading"></span>';
    loading.style.display = 'block';
    error.style.display = 'none';
    cacheInfo.style.display = 'none';

    try {
        const response = await fetch('/api/craft_prices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ profile })
        });

        const data = await response.json();

        if (data.success) {
            cachedData = data;
            renderResults(data);
            results.style.display = 'block';
        } else {
            document.getElementById('errorText').textContent = data.error;
            error.style.display = 'flex';
        }
    } catch (e) {
        document.getElementById('errorText').textContent = e.message;
        error.style.display = 'flex';
    } finally {
        loadBtn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
        loading.style.display = 'none';
        isLoading = false;
    }
}

function setMode(mode) {
    currentMode = mode;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    document.getElementById('modeFromScratch').classList.toggle('active', mode === 'scratch');
    document.getElementById('modeFromScratch').classList.toggle('btn-dark', mode !== 'scratch');
    document.getElementById('modeBuyComponents').classList.toggle('active', mode === 'buy');
    document.getElementById('modeBuyComponents').classList.toggle('btn-dark', mode !== 'buy');

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
    if (mode === 'scratch') {
        document.getElementById('modeHint').textContent = '–ö—Ä–∞—Ñ—Ç–∏–º –≤—Å—ë —Å–∞–º–∏ –∏–∑ –º–∏–Ω–µ—Ä–∞–ª–æ–≤';
        document.getElementById('tableTitle').textContent = '–ü—Ä–æ—Ñ–∏—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞—Ñ—Ç–∞ (—Å –Ω—É–ª—è)';
        document.getElementById('tableSubtitle').textContent = '–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –ø—Ä–æ—Ñ–∏—Ç—É –≤ —á–∞—Å. –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –∫—Ä–∞—Ñ—Ç–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.';
        document.getElementById('thResources').textContent = '–†–µ—Å—É—Ä—Å—ã';
    } else {
        document.getElementById('modeHint').textContent = '–ü–æ–∫—É–ø–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ';
        document.getElementById('tableTitle').textContent = '–ü—Ä–æ—Ñ–∏—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞—Ñ—Ç–∞ (—Å –ø–æ–∫—É–ø–∫–æ–π)';
        document.getElementById('tableSubtitle').textContent = '–ü–æ–∫—É–ø–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫—Ä–∞—Ñ—Ç–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥. –í—Ä–µ–º—è = —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫—Ä–∞—Ñ—Ç.';
        document.getElementById('thResources').textContent = '–ü–æ–∫—É–ø–∞–µ–º';
    }

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
    if (cachedData) {
        renderResults(cachedData);
    }
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    if (hours > 0) {
        return `${hours}—á ${minutes}–º`;
    }
    return `${minutes}–º`;
}

function renderResults(data) {
    // –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Ñ–∏—Ç–∞
    const profitTable = document.getElementById('profitTable');
    profitTable.innerHTML = '';

    if (data.profits && data.profits.length > 0) {
        // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–µ—Ü–µ–ø—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –∞–≤—Ç–æ–∫—Ä–∞—Ñ—Ç–µ
        const EXCLUDED_RECIPES = ['copperOre', 'twilightSteel', 'twilightAnthracite'];

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω—É–∂–Ω–æ–º—É –ø—Ä–æ—Ñ–∏—Ç—É –≤ —á–∞—Å
        let sorted = [...data.profits].filter(item => !EXCLUDED_RECIPES.includes(item.recipe_id));
        if (currentMode === 'buy') {
            sorted.sort((a, b) => (b.buy_profit_per_hour || 0) - (a.buy_profit_per_hour || 0));
        } else {
            sorted.sort((a, b) => b.profit_per_hour - a.profit_per_hour);
        }

        sorted.forEach(item => {
            let cost, profit, profitPercent, time, profitPerHour, resourcesHtml;

            if (currentMode === 'buy') {
                cost = item.buy_cost || 0;
                profit = item.buy_profit || 0;
                profitPercent = item.buy_profit_percent || 0;
                time = item.buy_time || 0;
                profitPerHour = item.buy_profit_per_hour || 0;

                // –ü–æ–∫—É–ø–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                let resources = [];
                if (item.buy_components && item.buy_components !== '–Ω–µ—Ç') {
                    resources.push(`üõí ${item.buy_components}`);
                }
                if (item.buy_minerals > 0) resources.push(`üíé${item.buy_minerals}`);
                if (item.buy_sapphires > 0) resources.push(`üí†${item.buy_sapphires}`);
                if (item.buy_rubies > 0) resources.push(`üî¥${item.buy_rubies}`);
                if (item.buy_silver > 0) resources.push(`ü™ô${item.buy_silver}`);
                resourcesHtml = resources.join(', ') || '-';
            } else {
                cost = item.full_cost;
                profit = item.full_profit;
                profitPercent = item.full_profit_percent;
                time = item.full_time;
                profitPerHour = item.profit_per_hour;

                // –†–µ—Å—É—Ä—Å—ã —Å –Ω—É–ª—è
                let resources = [];
                if (item.full_minerals > 0) resources.push(`üíé${item.full_minerals}`);
                if (item.full_sapphires > 0) resources.push(`üí†${item.full_sapphires}`);
                if (item.full_rubies > 0) resources.push(`üî¥${item.full_rubies}`);
                if (item.full_silver > 0) resources.push(`ü™ô${item.full_silver}`);
                resourcesHtml = resources.join(', ') || '-';
            }

            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign = profit >= 0 ? '+' : '';
            const hourClass = profitPerHour >= 0 ? 'positive' : 'negative';
            const hourSign = profitPerHour >= 0 ? '+' : '';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${item.name}</strong></td>
                <td>${item.sell_price.toFixed(2)}–∑</td>
                <td>${cost.toFixed(2)}–∑</td>
                <td class="${profitClass}">${profitSign}${profit.toFixed(2)}–∑</td>
                <td class="${profitClass}">${profitSign}${profitPercent.toFixed(0)}%</td>
                <td><span class="resource-badge">${resourcesHtml}</span></td>
                <td class="time-badge">${formatTime(time)}</td>
                <td class="profit-hour ${hourClass}">${hourSign}${profitPerHour.toFixed(1)}</td>
            `;
            profitTable.appendChild(row);
        });
    }

    // –°–µ—Ç–∫–∞ —Ü–µ–Ω –±–∞–∑–æ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    const pricesGrid = document.getElementById('pricesGrid');
    pricesGrid.innerHTML = '';

    if (data.prices) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        const baseResources = ['–ú–∏–Ω–µ—Ä–∞–ª', '–°–∞–ø—Ñ–∏—Ä', '–†—É–±–∏–Ω'];

        baseResources.forEach(name => {
            const price = data.prices[name];
            if (price !== undefined) {
                const card = document.createElement('div');
                card.className = 'price-card';
                card.innerHTML = `
                    <span class="price-name">${name}</span>
                    <span class="price-value">${price.toFixed(4)}–∑</span>
                `;
                pricesGrid.appendChild(card);
            }
        });
    }
}
</script>
{% endblock %}
