{% extends "base.html" %}

{% block title %}VMMO Bot - –û–±–∑–æ—Ä{% endblock %}

{% block content %}
{% macro render_bot_card(bot, rank=0) %}
<div class="card bot-card {{ bot.status }}">
    <div class="bot-card-header">
        <div class="bot-name-wrapper">
            {% if rank == 1 %}
            <span class="rank-badge rank-1" title="–¢–æ–ø-1 –ø–æ –¥–æ—Ö–æ–¥—É">ü•á</span>
            {% elif rank == 2 %}
            <span class="rank-badge rank-2" title="–¢–æ–ø-2 –ø–æ –¥–æ—Ö–æ–¥—É">ü•à</span>
            {% elif rank == 3 %}
            <span class="rank-badge rank-3" title="–¢–æ–ø-3 –ø–æ –¥–æ—Ö–æ–¥—É">ü•â</span>
            {% endif %}
            <span class="bot-name">{{ bot.name }}</span>
            {% if bot.is_main %}
            <span class="badge-main">MAIN</span>
            {% endif %}
        </div>
        <span class="status status-{{ bot.status }}">
            <span class="status-dot"></span>
            {{ '–†–ê–ë–û–¢–ê–ï–¢' if bot.status == 'running' else '–°–¢–û–ü' }}
        </span>
    </div>

    {% if bot.activity and bot.activity.activity %}
    <div class="bot-activity">
        {{ bot.activity.activity }}
    </div>
    {% endif %}

    {% if bot.craft and bot.craft.active %}
    <div class="bot-craft">
        <span class="craft-toggle" onclick="toggleCraftChain(event, '{{ bot.profile }}')" style="cursor: pointer;">
            {{ bot.craft.active }}
            {% if bot.craft.chain %}
            <span class="craft-arrow" id="craftArrow-{{ bot.profile }}">‚ñº</span>
            {% endif %}
        </span>
        {% if bot.craft.chain %}
        <div class="craft-chain" id="craftChain-{{ bot.profile }}" style="display: none; margin-top: 0.5rem; padding-left: 0.75rem; font-size: 0.85rem; border-left: 2px solid var(--border);">
            {% for item in bot.craft.chain %}
            <div style="margin-top: 0.25rem;">
                <span class="text-muted">‚Ä¢</span> {{ item.name }}:
                <span class="{{ 'text-success' if item.have >= item.amount else 'text-danger' }}">{{ item.have }}</span>/<span class="text-gold">{{ item.amount }}</span>
                {% if item.children %}
                <div style="padding-left: 0.75rem; border-left: 1px solid var(--border);">
                    {% for child in item.children %}
                    <div style="margin-top: 0.15rem;">
                        <span class="text-muted">‚Ä¢</span> {{ child.name }}:
                        <span class="{{ 'text-success' if child.have >= child.amount else 'text-danger' }}">{{ child.have }}</span>/<span class="text-gold">{{ child.amount }}</span>
                        {% if child.children %}
                        <div style="padding-left: 0.75rem; border-left: 1px solid var(--border);">
                            {% for grandchild in child.children %}
                            <div style="margin-top: 0.15rem;">
                                <span class="text-muted">‚Ä¢</span> {{ grandchild.name }}:
                                <span class="{{ 'text-success' if grandchild.have >= grandchild.amount else 'text-danger' }}">{{ grandchild.have }}</span>/<span class="text-gold">{{ grandchild.amount }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="bot-resources">
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/money_gold.png') }}" class="res-icon" width="18" height="18" alt="">
            <span class="text-gold">{{ bot.resources.get('–∑–æ–ª–æ—Ç–æ', 0) }}</span>
            {% if bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) != 0 %}
            <span class="resource-change {{ 'positive' if bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) > 0 else 'negative' }}">
                {{ '%+d' % bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) }}
            </span>
            {% endif %}
        </div>
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/money_silver.png') }}" class="res-icon" width="18" height="18" alt="">
            <span>{{ bot.resources.get('—Å–µ—Ä–µ–±—Ä–æ', 0) }}</span>
        </div>
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/skull.png') }}" class="res-icon" width="18" height="18" alt="">
            <span>{{ bot.resources.get('—á–µ—Ä–µ–ø–∞', 0) }}</span>
        </div>
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/mineral.png') }}" class="res-icon" width="18" height="18" alt="">
            <span>{{ bot.resources.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}</span>
            {% if bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) != 0 %}
            <span class="resource-change {{ 'positive' if bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) > 0 else 'negative' }}">
                {{ '%+d' % bot.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}
            </span>
            {% endif %}
        </div>
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/sapphire.png') }}" class="res-icon" width="18" height="18" alt="">
            <span>{{ bot.resources.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}</span>
            {% if bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) != 0 %}
            <span class="resource-change {{ 'positive' if bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) > 0 else 'negative' }}">
                {{ '%+d' % bot.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}
            </span>
            {% endif %}
        </div>
        <div class="resource-box">
            <img src="{{ url_for('static', filename='icons/ruby.png') }}" class="res-icon" width="18" height="18" alt="">
            <span>{{ bot.resources.get('—Ä—É–±–∏–Ω—ã', 0) }}</span>
            {% if bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) != 0 %}
            <span class="resource-change {{ 'positive' if bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) > 0 else 'negative' }}">
                {{ '%+d' % bot.earned.get('—Ä—É–±–∏–Ω—ã', 0) }}
            </span>
            {% endif %}
        </div>
    </div>

    {% if bot.hours > 0 %}
    <div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">
        –†–∞–±–æ—Ç–∞–µ—Ç: {{ '%.1f' % bot.hours }} —á
    </div>
    {% endif %}

    <div class="bot-actions">
        {% if bot.status == 'running' %}
        <button class="btn btn-sm btn-danger" onclick="stopBot('{{ bot.profile }}')">–°—Ç–æ–ø</button>
        <button class="btn btn-sm btn-warning" onclick="restartBot('{{ bot.profile }}')">–†–µ—Å—Ç–∞—Ä—Ç</button>
        {% else %}
        <button class="btn btn-sm btn-success" onclick="startBot('{{ bot.profile }}')">–°—Ç–∞—Ä—Ç</button>
        {% endif %}
        <a href="/config/{{ bot.profile }}" class="btn btn-sm btn-primary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a href="/logs/{{ bot.profile }}" class="btn btn-sm btn-ghost">–õ–æ–≥–∏</a>
    </div>
</div>
{% endmacro %}

<div class="flex flex-between flex-center mb-2 flex-wrap gap-1">
    <h1 class="page-title" style="margin: 0;">
        <span class="title-icon">üéÆ</span> –û–±–∑–æ—Ä –±–æ—Ç–æ–≤
    </h1>
    <div class="btn-group">
        <button class="btn btn-secondary" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-success" onclick="startAll()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ—Ö</button>
        <button class="btn btn-danger" onclick="stopAll()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ—Ö</button>
        <button class="btn btn-warning" onclick="resetAllSkips()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–∫–∏–ø—ã</button>
        <button class="btn btn-purple" onclick="sellAllCrafts()">üí∞ –ü—Ä–æ–¥–∞—Ç—å –∫—Ä–∞—Ñ—Ç—ã</button>
    </div>
</div>

<!-- –ú—É–ª—ã - –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è -->
{% if mules %}
<div class="mules-section">
    <h2 class="section-title">‚õèÔ∏è –ú—É–ª—ã <span class="text-muted">({{ mules_summary.running_count }}/{{ mules_summary.total_count }} —Ä–∞–±–æ—Ç–∞—é—Ç)</span></h2>

    <!-- –°–≤–æ–¥–∫–∞ –ø–æ –º—É–ª–∞–º -->
    <div class="card mules-summary" onclick="toggleMules()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleMules()}" role="button" tabindex="0" aria-expanded="false" id="mulesToggle">
        <div class="flex flex-between flex-center">
            <div>
                <strong>–í—Å–µ –º—É–ª—ã <span id="mulesArrow">‚ñ≤</span></strong>
                <div class="text-muted" style="font-size: 0.85rem;">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å</div>
            </div>
            <span class="status status-running">
                <span class="status-dot"></span>
                {{ mules_summary.running_count }}/{{ mules_summary.total_count }}
            </span>
        </div>

        <div class="mules-stats mt-1">
            <div class="grid grid-3 gap-1">
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/money_gold.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span class="text-gold">{{ mules_summary.resources.get('–∑–æ–ª–æ—Ç–æ', 0) }}</span>
                    {% if mules_summary.earned.get('–∑–æ–ª–æ—Ç–æ', 0) != 0 %}
                    <span class="resource-change {{ 'positive' if mules_summary.earned.get('–∑–æ–ª–æ—Ç–æ', 0) > 0 else 'negative' }}">
                        {{ '%+d' % mules_summary.earned.get('–∑–æ–ª–æ—Ç–æ', 0) }}
                    </span>
                    {% endif %}
                </div>
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/money_silver.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span>{{ mules_summary.resources.get('—Å–µ—Ä–µ–±—Ä–æ', 0) }}</span>
                </div>
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/skull.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span>{{ mules_summary.resources.get('—á–µ—Ä–µ–ø–∞', 0) }}</span>
                    {% if mules_summary.earned.get('—á–µ—Ä–µ–ø–∞', 0) != 0 %}
                    <span class="resource-change {{ 'positive' if mules_summary.earned.get('—á–µ—Ä–µ–ø–∞', 0) > 0 else 'negative' }}">
                        {{ '%+d' % mules_summary.earned.get('—á–µ—Ä–µ–ø–∞', 0) }}
                    </span>
                    {% endif %}
                </div>
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/mineral.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span>{{ mules_summary.resources.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}</span>
                    {% if mules_summary.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) != 0 %}
                    <span class="resource-change {{ 'positive' if mules_summary.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) > 0 else 'negative' }}">
                        {{ '%+d' % mules_summary.earned.get('–º–∏–Ω–µ—Ä–∞–ª—ã', 0) }}
                    </span>
                    {% endif %}
                </div>
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/sapphire.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span>{{ mules_summary.resources.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}</span>
                    {% if mules_summary.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) != 0 %}
                    <span class="resource-change {{ 'positive' if mules_summary.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) > 0 else 'negative' }}">
                        {{ '%+d' % mules_summary.earned.get('—Å–∞–ø—Ñ–∏—Ä—ã', 0) }}
                    </span>
                    {% endif %}
                </div>
                <div class="resource-box">
                    <img src="{{ url_for('static', filename='icons/ruby.png') }}" class="res-icon" width="18" height="18" alt="">
                    <span>{{ mules_summary.resources.get('—Ä—É–±–∏–Ω—ã', 0) }}</span>
                    {% if mules_summary.earned.get('—Ä—É–±–∏–Ω—ã', 0) != 0 %}
                    <span class="resource-change {{ 'positive' if mules_summary.earned.get('—Ä—É–±–∏–Ω—ã', 0) > 0 else 'negative' }}">
                        {{ '%+d' % mules_summary.earned.get('—Ä—É–±–∏–Ω—ã', 0) }}
                    </span>
                    {% endif %}
                </div>
            </div>

            {% if mules_summary.total_hours > 0 and mules_summary.running_count > 0 %}
            {% set avg_hours = mules_summary.total_hours / mules_summary.running_count %}
            <div class="mules-stats-footer">
                <div class="stat-item">
                    <span class="stat-label">‚è±Ô∏è –í—Ä–µ–º—è</span>
                    <span class="stat-value">~{{ '%.1f' % avg_hours }} —á</span>
                </div>
                {% if mules_summary.earned.get('–∑–æ–ª–æ—Ç–æ', 0) and avg_hours > 0 %}
                <div class="stat-item">
                    <span class="stat-label">üìà –°–∫–æ—Ä–æ—Å—Ç—å</span>
                    <span class="stat-value text-gold">{{ '%.1f' % (mules_summary.earned.get('–∑–æ–ª–æ—Ç–æ', 0) / avg_hours) }} –∑/—á</span>
                </div>
                {% endif %}
                {% if best_mule %}
                <div class="stat-item champion">
                    <span class="champion-badge">{{ best_mule.name }}</span>
                    <span class="stat-value text-gold">+{{ best_mule.earned.get('–∑–æ–ª–æ—Ç–æ', 0) }}g</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –º—É–ª–æ–≤ -->
    <div id="mulesGrid" class="grid grid-3 mt-1" style="display: none;">
        {% for bot in mules %}
        {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–Ω–≥ –ø–æ –¥–æ—Ö–æ–¥—É –∑–æ–ª–æ—Ç–∞ #}
        {% set gold_earned = bot.earned.get('–∑–æ–ª–æ—Ç–æ', 0) %}
        {% set rank = 0 %}
        {% if best_mule and bot.name == best_mule.name %}
            {% set rank = 1 %}
        {% elif mules_sorted and mules_sorted|length > 1 and bot.name == mules_sorted[1].name %}
            {% set rank = 2 %}
        {% elif mules_sorted and mules_sorted|length > 2 and bot.name == mules_sorted[2].name %}
            {% set rank = 3 %}
        {% endif %}
        {{ render_bot_card(bot, rank) }}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –ú–µ–π–Ω—ã -->
{% if mains %}
<h2 class="section-title mt-2">‚öîÔ∏è –ú–µ–π–Ω—ã</h2>
<div class="grid grid-3">
    {% for bot in mains %}
    {{ render_bot_card(bot) }}
    {% endfor %}
</div>
{% endif %}

<!-- –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö -->
{% if not mains and not mules %}
<div class="grid grid-3">
    {% for bot in stats %}
    {{ render_bot_card(bot) }}
    {% endfor %}
</div>
{% endif %}

<!-- Telegram –±–æ—Ç -->
<div class="tg-bot-section mt-2">
    <div class="card">
        <div class="flex flex-between flex-center">
            <div>
                <strong>Telegram –±–æ—Ç</strong>
                <span id="tgStatus" class="status status-stopped">
                    <span class="status-dot"></span>
                    <span id="tgStatusText">...</span>
                </span>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-success" onclick="tgAction('start')">–°—Ç–∞—Ä—Ç</button>
                <button class="btn btn-sm btn-danger" onclick="tgAction('stop')">–°—Ç–æ–ø</button>
                <button class="btn btn-sm btn-warning" onclick="tgAction('restart')">–†–µ—Å—Ç–∞—Ä—Ç</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ –∫—Ä–∞—Ñ—Ç–æ–≤ -->
<div id="sellCraftsModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeSellModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí∞ –ü—Ä–æ–¥–∞–∂–∞ –∫—Ä–∞—Ñ—Ç–æ–≤</h3>
            <button class="modal-close" onclick="closeSellModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>
        <div class="modal-body">
            <div id="sellProgress" class="sell-progress">
                <div class="progress-bar">
                    <div id="sellProgressBar" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="sellProgressText" class="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            </div>
            <div id="sellResults" class="sell-results"></div>
        </div>
        <div class="modal-footer">
            <button id="sellCloseBtn" class="btn btn-secondary" onclick="closeSellModal()" disabled>–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Terminal OS ‚Äî index.html overrides */

    .mules-summary {
        cursor: pointer;
    }

    .mules-summary:hover {
        border-color: var(--green);
    }

    .res-icon { width: 16px; height: 16px; }
    .res-icon-sm { width: 14px; height: 14px; vertical-align: middle; }

    .resource-box {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.3rem 0.4rem;
        border: 1px solid var(--border);
        font-size: 12px;
    }

    .resource-box:hover { border-color: var(--border-active); }
    .resource-box .resource-change { margin-left: 0; }

    .bot-name-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bot-name-wrapper .rank-badge {
        font-size: 1rem;
        background: none;
        width: auto;
        height: auto;
        border: none;
    }

    .badge-main {
        display: inline-block;
        padding: 0.1rem 0.35rem;
        border: 1px solid var(--green);
        color: var(--green);
        font-size: 10px;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
        letter-spacing: 0.04em;
    }

    .bot-card.running {
        border-left: 2px solid var(--green);
    }

    .bot-card.stopped { opacity: 0.5; }

    .bot-activity {
        font-size: 12px;
        padding: 0.3rem 0.5rem;
        background: rgba(245, 158, 11, 0.06);
        border-left: 2px solid var(--amber);
        margin: 0.5rem 0;
        color: var(--amber);
    }

    .bot-craft {
        font-size: 12px;
        padding: 0.3rem 0.5rem;
        background: rgba(34, 197, 94, 0.06);
        border-left: 2px solid var(--green);
        margin: 0.5rem 0;
        color: var(--green);
    }

    .tg-bot-section .card { padding: 0.75rem 1rem; }

    /* Modal ‚Äî Terminal OS */
    .modal {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
    }

    .modal-content {
        position: relative;
        background: var(--surface);
        border: 1px solid var(--border);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.625rem 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 12px;
        font-weight: 600;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-3);
        font-size: 16px;
        cursor: pointer;
        font-family: inherit;
    }
    .modal-close:hover { color: var(--red); }

    .modal-body {
        padding: 0.75rem;
        max-height: 50vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 0.625rem 0.75rem;
        border-top: 1px solid var(--border);
        text-align: right;
    }

    .progress-bar {
        height: 4px;
        background: var(--border);
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-fill {
        height: 100%;
        background: var(--green);
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 11px;
        color: var(--text-3);
        margin-bottom: 0.75rem;
    }

    .sell-results { font-size: 12px; }

    .sell-result-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.02);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .sell-result-item:last-child { border-bottom: none; }
    .sell-result-item.success { color: var(--green); }
    .sell-result-item.skipped { color: var(--amber); }
    .sell-result-item.error { color: var(--red); }
    .sell-result-item.empty { color: var(--text-3); }
    .sell-result-item.processing { color: var(--blue); }
</style>

<script>
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –∏–∑ localStorage
    let mulesExpanded = localStorage.getItem('mulesExpanded') === 'true';

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const grid = document.getElementById('mulesGrid');
        const arrow = document.getElementById('mulesArrow');
        if (grid && arrow && mulesExpanded) {
            grid.style.display = 'grid';
            arrow.textContent = '‚ñº';
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å TG –±–æ—Ç–∞
        checkTgStatus();
    });

    function toggleMules() {
        mulesExpanded = !mulesExpanded;
        localStorage.setItem('mulesExpanded', mulesExpanded);

        const grid = document.getElementById('mulesGrid');
        const arrow = document.getElementById('mulesArrow');
        const toggle = document.getElementById('mulesToggle');

        if (mulesExpanded) {
            grid.style.display = 'grid';
            arrow.textContent = '‚ñº';
        } else {
            grid.style.display = 'none';
            arrow.textContent = '‚ñ≤';
        }
        if (toggle) toggle.setAttribute('aria-expanded', mulesExpanded);
    }

    function toggleCraftChain(event, profile) {
        event.stopPropagation();
        const chain = document.getElementById('craftChain-' + profile);
        const arrow = document.getElementById('craftArrow-' + profile);
        if (!chain) return;

        if (chain.style.display === 'none') {
            chain.style.display = 'block';
            if (arrow) arrow.textContent = '‚ñ≤';
        } else {
            chain.style.display = 'none';
            if (arrow) arrow.textContent = '‚ñº';
        }
    }

    async function resetAllSkips() {
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å–∫–∏–ø—ã –¥–∞–Ω–∂–µ–π?')) return;
        const result = await apiCall('/api/reset_skips', 'POST');
        showToast(result.success ? '–°–∫–∏–ø—ã —Å–±—Ä–æ—à–µ–Ω—ã!' : '–û—à–∏–±–∫–∞', result.success ? 'success' : 'error');
    }

    let sellEventSource = null;

    function openSellModal() {
        document.getElementById('sellCraftsModal').style.display = 'flex';
        document.getElementById('sellResults').innerHTML = '';
        document.getElementById('sellProgressBar').style.width = '0%';
        document.getElementById('sellProgressText').textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
        document.getElementById('sellCloseBtn').disabled = true;
        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–µ—Ñ—Ä–µ—à –ø–æ–∫–∞ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞
        if (window.disableAutoRefresh) window.disableAutoRefresh();
    }

    function closeSellModal() {
        document.getElementById('sellCraftsModal').style.display = 'none';
        if (sellEventSource) {
            sellEventSource.close();
            sellEventSource = null;
        }
        // –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–µ—Ñ—Ä–µ—à –æ–±—Ä–∞—Ç–Ω–æ
        if (window.enableAutoRefresh) window.enableAutoRefresh();
    }

    function addSellResult(icon, name, text, cssClass) {
        const results = document.getElementById('sellResults');
        const item = document.createElement('div');
        item.className = `sell-result-item ${cssClass}`;
        item.innerHTML = `<span>${icon}</span><span>${name}:</span><span>${text}</span>`;
        results.appendChild(item);
        results.scrollTop = results.scrollHeight;
    }

    function sellAllCrafts() {
        if (!confirm('–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ –∫—Ä–∞—Ñ—Ç—ã?')) return;

        openSellModal();

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SSE
        sellEventSource = new EventSource('/api/sell_crafts/stream');

        sellEventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'start') {
                    document.getElementById('sellProgressText').textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ 0/${data.total} –ø—Ä–æ—Ñ–∏–ª–µ–π...`;
                }
                else if (data.type === 'processing') {
                    const pct = Math.round((data.current - 1) / data.total * 100);
                    document.getElementById('sellProgressBar').style.width = pct + '%';
                    document.getElementById('sellProgressText').textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ ${data.current}/${data.total}: ${data.name}...`;
                }
                else if (data.type === 'result') {
                    const pct = Math.round(data.current / data.total * 100);
                    document.getElementById('sellProgressBar').style.width = pct + '%';
                    document.getElementById('sellProgressText').textContent = `–ì–æ—Ç–æ–≤–æ ${data.current}/${data.total}`;

                    if (data.skipped) {
                        addSellResult('‚è≠Ô∏è', data.name, '–ø—Ä–æ–ø—É—â–µ–Ω (–±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç)', 'skipped');
                    } else if (data.error) {
                        addSellResult('‚ùå', data.name, data.error, 'error');
                    } else if (data.sold > 0) {
                        addSellResult('‚úÖ', data.name, `–ø—Ä–æ–¥–∞–Ω–æ ${data.sold}`, 'success');
                    } else {
                        addSellResult('üì≠', data.name, '–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'empty');
                    }
                }
                else if (data.done) {
                    document.getElementById('sellProgressBar').style.width = '100%';
                    document.getElementById('sellProgressText').textContent = '–ì–æ—Ç–æ–≤–æ!';
                    document.getElementById('sellCloseBtn').disabled = false;
                    sellEventSource.close();
                    sellEventSource = null;
                }
            } catch (e) {
                console.error('SSE parse error:', e, event.data);
            }
        };

        sellEventSource.onerror = function(e) {
            document.getElementById('sellProgressText').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            document.getElementById('sellCloseBtn').disabled = false;
            sellEventSource.close();
            sellEventSource = null;
        };
    }

    // TG –±–æ—Ç
    async function checkTgStatus() {
        try {
            const result = await apiCall('/api/telegram_bot/status');
            const statusEl = document.getElementById('tgStatus');
            const textEl = document.getElementById('tgStatusText');
            if (result.running) {
                statusEl.className = 'status status-running';
                textEl.textContent = '–†–ê–ë–û–¢–ê–ï–¢';
            } else {
                statusEl.className = 'status status-stopped';
                textEl.textContent = '–°–¢–û–ü';
            }
        } catch (e) {
            console.error('TG status error:', e);
        }
    }

    async function tgAction(action) {
        const result = await apiCall(`/api/telegram_bot/${action}`, 'POST');
        showToast(result.success ? `TG –±–æ—Ç: ${action}` : '–û—à–∏–±–∫–∞', result.success ? 'success' : 'error');
        setTimeout(checkTgStatus, 2000);
    }
</script>
{% endblock %}
