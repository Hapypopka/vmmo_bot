{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {{ name }} - VMMO Bot Panel{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1 class="page-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {{ name }}</h1>
    <a href="/" class="btn btn-dark">–ù–∞–∑–∞–¥</a>
</div>

<div class="grid grid-2">
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="card">
        <h3 class="card-title">–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>

        <div class="form-group flex flex-between flex-center">
            <label>–î–∞–Ω–∂–∏</label>
            <label class="toggle">
                <input type="checkbox" id="dungeons_enabled"
                       {{ 'checked' if config.get('dungeons_enabled', True) }}
                       onchange="toggleSetting('{{ profile }}', 'dungeons_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–ê—Ä–µ–Ω–∞</label>
            <label class="toggle">
                <input type="checkbox" id="arena_enabled"
                       {{ 'checked' if config.get('arena_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'arena_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–ê–¥—Å–∫–∏–µ –ò–≥—Ä—ã</label>
            <label class="toggle">
                <input type="checkbox" id="hell_games_enabled"
                       {{ 'checked' if config.get('hell_games_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'hell_games_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>üíò –í–∞–ª–µ–Ω—Ç–∏–Ω –∏–≤–µ–Ω—Ç</label>
            <label class="toggle">
                <input type="checkbox" id="valentine_event_enabled"
                       {{ 'checked' if config.get('valentine_event_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'valentine_event_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–®–∞—Ö—Ç–∞ –≤—ã–∂–∏–≤–∞–Ω–∏—è</label>
            <label class="toggle">
                <input type="checkbox" id="survival_mines_enabled"
                       {{ 'checked' if config.get('survival_mines_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'survival_mines_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–ö—Ä–∞—Ñ—Ç</label>
            <label class="toggle">
                <input type="checkbox" id="iron_craft_enabled"
                       {{ 'checked' if config.get('iron_craft_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'iron_craft_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–í–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–µ–≤</label>
            <label class="toggle">
                <input type="checkbox" id="pet_resurrection_enabled"
                       {{ 'checked' if config.get('pet_resurrection_enabled', False) }}
                       onchange="toggleSetting('{{ profile }}', 'pet_resurrection_enabled')">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- –ö—Ä–∞—Ñ—Ç -->
    <div class="card">
        <h3 class="card-title">–û—á–µ—Ä–µ–¥—å –∫—Ä–∞—Ñ—Ç–∞</h3>

        <!-- –ê–≤—Ç–æ–≤—ã–±–æ—Ä –∫—Ä–∞—Ñ—Ç–∞ -->
        <div class="form-group flex flex-between flex-center mb-1" style="padding-bottom: 1rem; border-bottom: 1px solid #333;">
            <div>
                <label>–ê–≤—Ç–æ–≤—ã–±–æ—Ä –∫—Ä–∞—Ñ—Ç–∞</label>
                <div class="text-muted" style="font-size: 0.75rem;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π –∫—Ä–∞—Ñ—Ç</div>
            </div>
            <label class="toggle">
                <input type="checkbox" id="auto_select_craft"
                       {{ 'checked' if config.get('auto_select_craft', True) }}
                       onchange="toggleSetting('{{ profile }}', 'auto_select_craft')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- –ü—Ä–æ–¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ñ—Ç—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ -->
        <div class="form-group flex flex-between flex-center mb-1" style="padding-bottom: 1rem; border-bottom: 1px solid #333;">
            <div>
                <label>–ü—Ä–æ–¥–∞–≤–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ</label>
                <div class="text-muted" style="font-size: 0.75rem;">–ü—Ä–æ–¥–∞—ë—Ç –≤—Å–µ –∫—Ä–∞—Ñ—Ç—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞</div>
            </div>
            <label class="toggle">
                <input type="checkbox" id="sell_crafts_on_startup"
                       {{ 'checked' if config.get('sell_crafts_on_startup', True) }}
                       onchange="toggleSetting('{{ profile }}', 'sell_crafts_on_startup')">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫—Ä–∞—Ñ—Ç–∞ -->
        <div id="craft-items-list" class="mb-1">
            {% set craft_items = config.get('craft_items', []) %}
            {% if craft_items %}
                {% for item in craft_items %}
                <div class="craft-item flex flex-between flex-center" style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                    <span>
                        <strong>{{ craftable_items.get(item.item, item.item) }}</strong>
                        <span class="text-muted">(–ø–∞—Ä—Ç–∏—è: {{ item.batch_size }} —à—Ç)</span>
                    </span>
                    <button class="btn btn-sm btn-danger" onclick="removeCraftItem('{{ profile }}', {{ loop.index0 }})" style="padding: 0.25rem 0.5rem;">‚úï</button>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted" id="empty-items-msg">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>
            {% endif %}
        </div>

        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
        <div class="form-group">
            <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</label>
            <div class="flex gap-1">
                <select class="form-input" id="craft_item" style="flex: 2;">
                    {% for item_id, item_name in craftable_items.items() %}
                    <option value="{{ item_id }}">{{ item_name }}</option>
                    {% endfor %}
                </select>
                <input type="number" class="form-input" id="craft_batch_size" value="5" min="1" placeholder="–ü–∞—Ä—Ç–∏—è" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCraftItem('{{ profile }}')" style="flex: 1;">+</button>
            </div>
        </div>

        {% if craft_items %}
        <button class="btn btn-danger btn-sm" onclick="clearCraftItems('{{ profile }}')">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        {% endif %}
    </div>

    <!-- –ü—Ä–æ–¥–∞–∂–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <div class="card">
        <h3 class="card-title">–ü—Ä–æ–¥–∞–∂–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</h3>

        {% set resource_sell = config.get('resource_sell', {}) %}

        {% for res_key, res_name in resource_names.items() %}
        {% set res_cfg = resource_sell.get(res_key, {'enabled': False, 'stack': 1000, 'reserve': 200}) %}
        <div class="form-group" style="border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 1rem;">
            <div class="flex flex-between flex-center mb-1">
                <strong>{{ res_name }}</strong>
                <label class="toggle">
                    <input type="checkbox" id="sell_{{ res_key }}"
                           {{ 'checked' if res_cfg.get('enabled', False) }}
                           onchange="toggleResourceSell('{{ profile }}', '{{ res_key }}')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="grid grid-2" style="gap: 0.5rem;">
                <div>
                    <label class="form-label">–°—Ç–∞–∫</label>
                    <input type="number" class="form-input" id="sell_{{ res_key }}_stack"
                           value="{{ res_cfg.get('stack', 1000) }}"
                           onchange="saveResourceSell('{{ profile }}', '{{ res_key }}')">
                </div>
                <div>
                    <label class="form-label">–†–µ–∑–µ—Ä–≤</label>
                    <input type="number" class="form-input" id="sell_{{ res_key }}_reserve"
                           value="{{ res_cfg.get('reserve', 200) }}"
                           onchange="saveResourceSell('{{ profile }}', '{{ res_key }}')">
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –î–∞–Ω–∂–∏ -->
    <div class="card">
        <h3 class="card-title">–î–∞–Ω–∂–∏</h3>

        {% set only_dungeons = config.get('only_dungeons', []) %}

        {% for dng_id, dng_name in all_dungeons.items() %}
        <div class="form-group flex flex-between flex-center">
            <label>{{ dng_name }}</label>
            <label class="toggle">
                <input type="checkbox"
                       {{ 'checked' if dng_id in only_dungeons }}
                       onchange="toggleDungeon('{{ profile }}', '{{ dng_id }}')">
                <span class="toggle-slider"></span>
            </label>
        </div>
        {% endfor %}
    </div>

    <!-- –°–∫–∏–ª–ª—ã -->
    <div class="card">
        <h3 class="card-title">–°–∫–∏–ª–ª—ã</h3>

        {% set cooldowns = config.get('skill_cooldowns', {}) %}
        {% set hp_thresholds = config.get('skill_hp_thresholds', {}) %}

        <p class="text-muted mb-1">–ö—É–ª–¥–∞—É–Ω (—Å–µ–∫) –∏ –ø–æ—Ä–æ–≥ HP (%) –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫–∏–ª–ª–∞</p>

        <div class="grid grid-2" style="gap: 0.5rem;">
            <div class="form-group">
                <label class="form-label">–°–∫–∏–ª–ª 1 –ö–î (—Å–µ–∫)</label>
                <input type="number" step="0.5" class="form-input" id="cd_1"
                       value="{{ cooldowns.get('1', 0) }}"
                       onchange="saveCooldowns('{{ profile }}')">
            </div>
            <div class="form-group">
                <label class="form-label">HP –ø–æ—Ä–æ–≥ (%)</label>
                <input type="number" class="form-input" id="hp_1"
                       value="{{ hp_thresholds.get('1', '') }}"
                       placeholder="–ù–µ—Ç"
                       onchange="saveHpThresholds('{{ profile }}')">
            </div>
        </div>

        <div class="grid grid-2" style="gap: 0.5rem;">
            <div class="form-group">
                <label class="form-label">–°–∫–∏–ª–ª 2 –ö–î (—Å–µ–∫)</label>
                <input type="number" step="0.5" class="form-input" id="cd_2"
                       value="{{ cooldowns.get('2', 0) }}"
                       onchange="saveCooldowns('{{ profile }}')">
            </div>
            <div class="form-group">
                <label class="form-label">HP –ø–æ—Ä–æ–≥ (%)</label>
                <input type="number" class="form-input" id="hp_2"
                       value="{{ hp_thresholds.get('2', '') }}"
                       placeholder="–ù–µ—Ç"
                       onchange="saveHpThresholds('{{ profile }}')">
            </div>
        </div>

        <div class="grid grid-2" style="gap: 0.5rem;">
            <div class="form-group">
                <label class="form-label">–°–∫–∏–ª–ª 3 –ö–î (—Å–µ–∫)</label>
                <input type="number" step="0.5" class="form-input" id="cd_3"
                       value="{{ cooldowns.get('3', 0) }}"
                       onchange="saveCooldowns('{{ profile }}')">
            </div>
            <div class="form-group">
                <label class="form-label">HP –ø–æ—Ä–æ–≥ (%)</label>
                <input type="number" class="form-input" id="hp_3"
                       value="{{ hp_thresholds.get('3', '') }}"
                       placeholder="–ù–µ—Ç"
                       onchange="saveHpThresholds('{{ profile }}')">
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ—á–µ–µ -->
    <div class="card">
        <h3 class="card-title">–ü—Ä–æ—á–µ–µ</h3>

        <div class="form-group">
            <label class="form-label">–ü–æ—Ä–æ–≥ —Ä—é–∫–∑–∞–∫–∞ (—Å–ª–æ—Ç–æ–≤)</label>
            <input type="number" class="form-input" id="backpack_threshold"
                   value="{{ config.get('backpack_threshold', 18) }}"
                   onchange="saveValue('{{ profile }}', 'backpack_threshold', this.value)">
        </div>

        <div class="form-group">
            <label class="form-label">–õ–∏–º–∏—Ç –±–æ—ë–≤ –∞—Ä–µ–Ω—ã</label>
            <input type="number" class="form-input" id="arena_max_fights"
                   value="{{ config.get('arena_max_fights', 50) }}"
                   onchange="saveValue('{{ profile }}', 'arena_max_fights', this.value)">
        </div>

        <div class="form-group">
            <label class="form-label">–ú–∞–∫—Å –≤–æ–ª–Ω–∞ —à–∞—Ö—Ç—ã</label>
            <input type="number" class="form-input" id="survival_mines_max_wave"
                   value="{{ config.get('survival_mines_max_wave', 31) }}"
                   onchange="saveValue('{{ profile }}', 'survival_mines_max_wave', this.value)">
        </div>

        <div class="form-group">
            <label class="form-label">–ú–∞–∫—Å —É—Ä–æ–≤–µ–Ω—å —à–∞—Ö—Ç—ã (–ø—É—Å—Ç–æ=–ª—é–±–æ–π)</label>
            <input type="number" class="form-input" id="survival_mines_max_level"
                   value="{{ config.get('survival_mines_max_level', '') }}"
                   placeholder="–õ—é–±–æ–π"
                   onchange="saveValueOrNull('{{ profile }}', 'survival_mines_max_level', this.value)">
        </div>

        <div class="form-group flex flex-between flex-center">
            <label>–°—Ç–æ—Ä–æ–Ω–∞ –°–≤–µ—Ç–∞ (–ê–¥. –ò–≥—Ä—ã)</label>
            <label class="toggle">
                <input type="checkbox" id="is_light_side"
                       {{ 'checked' if config.get('is_light_side', False) }}
                       onchange="toggleSetting('{{ profile }}', 'is_light_side')">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- –°—Å—ã–ª–∫–∏ -->
    <div class="card">
        <h3 class="card-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
        <div class="flex gap-1">
            <a href="/deaths/{{ profile }}" class="btn btn-purple">–°–º–µ—Ä—Ç–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</a>
            <a href="/logs/{{ profile }}" class="btn btn-dark">–õ–æ–≥–∏</a>
        </div>
    </div>
</div>

<!-- JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
<div class="card mt-2">
    <h3 class="card-title">Raw JSON –∫–æ–Ω—Ñ–∏–≥</h3>
    <textarea id="json_config" class="form-input" style="font-family: monospace; min-height: 300px;">{{ config | tojson(indent=2) }}</textarea>
    <button class="btn btn-primary mt-1" onclick="saveRawConfig('{{ profile }}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleResourceSell(profile, resource) {
        const config = await apiCall(`/api/config/${profile}`);
        if (!config.resource_sell) config.resource_sell = {};
        if (!config.resource_sell[resource]) {
            config.resource_sell[resource] = {enabled: false, stack: 1000, reserve: 200};
        }
        config.resource_sell[resource].enabled = !config.resource_sell[resource].enabled;
        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        const state = config.resource_sell[resource].enabled ? '–í–ö–õ' : '–í–´–ö–õ';
        showToast(`–ü—Ä–æ–¥–∞–∂–∞ ${resource}: ${state}`, result.success ? 'success' : 'error');
    }

    async function saveResourceSell(profile, resource) {
        const config = await apiCall(`/api/config/${profile}`);
        if (!config.resource_sell) config.resource_sell = {};
        if (!config.resource_sell[resource]) {
            config.resource_sell[resource] = {enabled: false, stack: 1000, reserve: 200};
        }
        config.resource_sell[resource].stack = parseInt(document.getElementById(`sell_${resource}_stack`).value) || 1000;
        config.resource_sell[resource].reserve = parseInt(document.getElementById(`sell_${resource}_reserve`).value) || 200;
        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', result.success ? 'success' : 'error');
    }

    async function toggleDungeon(profile, dungeonId) {
        const config = await apiCall(`/api/config/${profile}`);
        if (!config.only_dungeons) config.only_dungeons = [];

        const idx = config.only_dungeons.indexOf(dungeonId);
        if (idx > -1) {
            config.only_dungeons.splice(idx, 1);
            showToast('–î–∞–Ω–∂–µ–Ω —É–±—Ä–∞–Ω', 'success');
        } else {
            config.only_dungeons.push(dungeonId);
            showToast('–î–∞–Ω–∂–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }
        await apiCall(`/api/config/${profile}`, 'POST', config);
    }

    // === –û—á–µ—Ä–µ–¥—å –∫—Ä–∞—Ñ—Ç–∞ ===
    async function addCraftItem(profile) {
        const item = document.getElementById('craft_item').value;
        const batch_size = parseInt(document.getElementById('craft_batch_size').value) || 5;

        const result = await apiCall(`/api/craft_items/${profile}/add`, 'POST', {item, batch_size});
        if (result.success) {
            showToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), 'error');
        }
    }

    async function removeCraftItem(profile, index) {
        const result = await apiCall(`/api/craft_items/${profile}/remove`, 'POST', {index});
        if (result.success) {
            showToast('–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª—ë–Ω', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), 'error');
        }
    }

    async function clearCraftItems(profile) {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–∫—Ä–∞—Ñ—Ç–∞?')) return;

        const result = await apiCall(`/api/craft_items/${profile}/clear`, 'POST', {});
        if (result.success) {
            showToast('–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), 'error');
        }
    }

    async function saveCooldowns(profile) {
        const config = await apiCall(`/api/config/${profile}`);
        if (!config.skill_cooldowns) config.skill_cooldowns = {};

        const cd1 = parseFloat(document.getElementById('cd_1').value);
        const cd2 = parseFloat(document.getElementById('cd_2').value);
        const cd3 = parseFloat(document.getElementById('cd_3').value);

        if (cd1 > 0) config.skill_cooldowns['1'] = cd1;
        else delete config.skill_cooldowns['1'];

        if (cd2 > 0) config.skill_cooldowns['2'] = cd2;
        else delete config.skill_cooldowns['2'];

        if (cd3 > 0) config.skill_cooldowns['3'] = cd3;
        else delete config.skill_cooldowns['3'];

        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        showToast('–ö—É–ª–¥–∞—É–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', result.success ? 'success' : 'error');
    }

    async function saveValue(profile, key, value) {
        const config = await apiCall(`/api/config/${profile}`);
        config[key] = parseInt(value) || value;
        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', result.success ? 'success' : 'error');
    }

    async function saveValueOrNull(profile, key, value) {
        const config = await apiCall(`/api/config/${profile}`);
        if (value && parseInt(value) > 0) {
            config[key] = parseInt(value);
        } else {
            delete config[key];
        }
        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', result.success ? 'success' : 'error');
    }

    async function saveHpThresholds(profile) {
        const config = await apiCall(`/api/config/${profile}`);
        if (!config.skill_hp_thresholds) config.skill_hp_thresholds = {};

        const hp1 = parseInt(document.getElementById('hp_1').value);
        const hp2 = parseInt(document.getElementById('hp_2').value);
        const hp3 = parseInt(document.getElementById('hp_3').value);

        if (hp1 > 0) config.skill_hp_thresholds['1'] = hp1;
        else delete config.skill_hp_thresholds['1'];

        if (hp2 > 0) config.skill_hp_thresholds['2'] = hp2;
        else delete config.skill_hp_thresholds['2'];

        if (hp3 > 0) config.skill_hp_thresholds['3'] = hp3;
        else delete config.skill_hp_thresholds['3'];

        const result = await apiCall(`/api/config/${profile}`, 'POST', config);
        showToast('HP –ø–æ—Ä–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', result.success ? 'success' : 'error');
    }

    async function saveRawConfig(profile) {
        try {
            const json = JSON.parse(document.getElementById('json_config').value);
            const result = await apiCall(`/api/config/${profile}`, 'POST', json);
            if (result.success) {
                showToast('–ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('–û—à–∏–±–∫–∞: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞ JSON: ' + e.message, 'error');
        }
    }
</script>
{% endblock %}
