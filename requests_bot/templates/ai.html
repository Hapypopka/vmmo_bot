{% extends "base.html" %}

{% block title %}Debug Center - VMMO Bot Panel{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1 class="page-title">Debug Center</h1>
    <a href="/" class="btn btn-dark">–ù–∞–∑–∞–¥</a>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã -->
<div class="card mb-2">
    <h3 class="card-title">–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
    <div class="debug-commands">
        <button class="btn btn-primary" onclick="runCommand('status')">
            –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
        </button>
        <button class="btn btn-info" onclick="runCommand('errors')">
            –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
        </button>
        <button class="btn btn-warning" onclick="runCommand('processes')">
            –ü—Ä–æ—Ü–µ—Å—Å—ã
        </button>
        <button class="btn btn-dark" onclick="runCommand('locks')">
            Lock —Ñ–∞–π–ª—ã
        </button>
    </div>
</div>

<!-- –õ–æ–≥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
<div class="card mb-2">
    <h3 class="card-title">–õ–æ–≥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
    <div class="flex gap-1">
        <select id="logProfile" class="form-input" style="flex: 1;" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
            {% for profile, name in profiles.items() %}
            <option value="{{ profile }}">{{ name }} ({{ profile }})</option>
            {% endfor %}
        </select>
        <select id="logLines" class="form-input" style="width: 100px;" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫">
            <option value="50">50 —Å—Ç—Ä–æ–∫</option>
            <option value="100" selected>100 —Å—Ç—Ä–æ–∫</option>
            <option value="200">200 —Å—Ç—Ä–æ–∫</option>
            <option value="500">500 —Å—Ç—Ä–æ–∫</option>
        </select>
        <button class="btn btn-success" onclick="getLogs()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="btn btn-danger" onclick="getErrors()">–û—à–∏–±–∫–∏</button>
    </div>
</div>

<!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã -->
<div class="card mb-2">
    <h3 class="card-title">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã</h3>
    <p class="text-muted mb-1">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É - —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç –ø—Ä–∏—á–∏–Ω—É –≤ –ª–æ–≥–∞—Ö –∏ –∫–æ–¥–µ</p>
    <div class="flex gap-1">
        <select id="debugProfile" class="form-input" style="width: 150px;" aria-label="–ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏">
            <option value="">–í—Å–µ –±–æ—Ç—ã</option>
            {% for profile, name in profiles.items() %}
            <option value="{{ profile }}">{{ name }}</option>
            {% endfor %}
        </select>
        <input type="text" id="debugProblem" class="form-input" style="flex: 1;"
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª—É—Ç, –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –≤ –¥–∞–Ω–∂–µ‚Ä¶" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã">
        <button class="btn btn-primary" onclick="runDiagnostics()" id="diagBtn">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
    </div>
    <div class="mt-1">
        <small class="text-muted">–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</small>
        <div class="debug-suggestions">
            <span class="suggestion" onclick="setDebugProblem('–±–æ—Ç –∑–∞—Å—Ç—Ä—è–ª')">–∑–∞—Å—Ç—Ä—è–ª</span>
            <span class="suggestion" onclick="setDebugProblem('–Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª—É—Ç')">–ª—É—Ç</span>
            <span class="suggestion" onclick="setDebugProblem('–∫—Ä–∞—Ñ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç')">–∫—Ä–∞—Ñ—Ç</span>
            <span class="suggestion" onclick="setDebugProblem('—É–º–∏—Ä–∞–µ—Ç –≤ –¥–∞–Ω–∂–µ')">—Å–º–µ—Ä—Ç–∏</span>
            <span class="suggestion" onclick="setDebugProblem('—Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞')">—Å–µ—Å—Å–∏—è</span>
            <span class="suggestion" onclick="setDebugProblem('–æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è')">connection</span>
        </div>
    </div>
</div>

<!-- –°–≤–æ–π –≤–æ–ø—Ä–æ—Å –∫ Claude -->
<div class="card mb-2">
    <h3 class="card-title">–í–æ–ø—Ä–æ—Å –∫ Claude</h3>
    <div class="form-group">
        <textarea class="form-input" id="question" rows="2"
                  placeholder="–õ—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ –±–æ—Ç–∞—Ö, –∫–æ–¥–µ –∏–ª–∏ –∏–≥—Ä–µ‚Ä¶" aria-label="–í–æ–ø—Ä–æ—Å –∫ Claude"></textarea>
    </div>
    <button class="btn btn-success" onclick="askQuestion()" id="askBtn">–°–ø—Ä–æ—Å–∏—Ç—å</button>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="result" class="card mb-2" style="display: none;">
    <div class="flex flex-between flex-center">
        <h3 class="card-title" id="resultTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
        <div>
            <button class="btn btn-sm btn-dark" onclick="copyResult()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-sm btn-danger" onclick="clearResult()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
    <div id="resultOutput" class="log-viewer"></div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
<div id="loading" class="card" style="display: none;">
    <div class="text-center">
        <div class="spinner"></div>
        <p class="text-muted mt-1" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
</div>

<!-- –û—à–∏–±–∫–∞ -->
<div id="error" class="alert alert-danger mt-2" style="display: none;"></div>

<style>
/* Terminal OS ‚Äî ai overrides */
.debug-commands { display: flex; gap: 0.375rem; flex-wrap: wrap; }
.debug-suggestions { display: flex; gap: 0.375rem; flex-wrap: wrap; margin-top: 0.375rem; }
.suggestion {
    border: 1px solid var(--border);
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    font-size: 11px;
    color: var(--text-2);
    transition: border-color 0.1s, color 0.1s;
}
.suggestion:hover { border-color: var(--green); color: var(--green); }
.spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
}
.log-viewer .error { color: var(--red); }
.log-viewer .warning { color: var(--amber); }
.log-viewer .success { color: var(--green); }
.log-viewer .info { color: var(--blue); }
</style>
{% endblock %}

{% block scripts %}
<script>
    function showLoading(text) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loadingText').textContent = text || '–ó–∞–≥—Ä—É–∑–∫–∞...';
        document.getElementById('error').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function showResult(title, content) {
        document.getElementById('resultTitle').textContent = title;
        document.getElementById('resultOutput').innerHTML = formatOutput(content);
        document.getElementById('result').style.display = 'block';
        hideLoading();
    }

    function showError(msg) {
        document.getElementById('error').textContent = msg;
        document.getElementById('error').style.display = 'block';
        hideLoading();
    }

    function clearResult() {
        document.getElementById('result').style.display = 'none';
    }

    function copyResult() {
        const text = document.getElementById('resultOutput').innerText;
        navigator.clipboard.writeText(text);
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
    }

    function formatOutput(text) {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        return text
            .replace(/\[ERROR\]|ERROR|Exception|Traceback|failed|FAILED/gi, '<span class="error">$&</span>')
            .replace(/\[WARNING\]|WARNING|warn/gi, '<span class="warning">$&</span>')
            .replace(/\[INFO\]|SUCCESS|completed|done|OK/gi, '<span class="info">$&</span>')
            .replace(/üü¢|‚úÖ|running/gi, '<span class="success">$&</span>')
            .replace(/üî¥|‚ùå|stopped/gi, '<span class="error">$&</span>')
            .replace(/üü°/g, '<span class="warning">$&</span>');
    }

    function setDebugProblem(text) {
        document.getElementById('debugProblem').value = text;
    }

    // –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
    async function runCommand(cmd) {
        showLoading('–í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É...');
        try {
            const response = await fetch('/api/debug/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: cmd })
            });
            const data = await response.json();
            if (data.success) {
                showResult(data.title || '–†–µ–∑—É–ª—å—Ç–∞—Ç', data.output);
            } else {
                showError(data.error);
            }
        } catch (e) {
            showError('–û—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // –õ–æ–≥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    async function getLogs() {
        const profile = document.getElementById('logProfile').value;
        const lines = document.getElementById('logLines').value;
        showLoading('–ü–æ–ª—É—á–∞—é –ª–æ–≥–∏...');
        try {
            const response = await fetch(`/api/debug/logs/${profile}?lines=${lines}`);
            const data = await response.json();
            if (data.success) {
                showResult(`–õ–æ–≥–∏ ${data.name}`, data.logs);
            } else {
                showError(data.error);
            }
        } catch (e) {
            showError('–û—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // –û—à–∏–±–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    async function getErrors() {
        const profile = document.getElementById('logProfile').value;
        showLoading('–ò—â—É –æ—à–∏–±–∫–∏...');
        try {
            const response = await fetch(`/api/debug/errors/${profile}`);
            const data = await response.json();
            if (data.success) {
                const output = data.errors.length > 0
                    ? data.errors.join('\n')
                    : '–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!';
                showResult(`–û—à–∏–±–∫–∏ ${data.name}`, output);
            } else {
                showError(data.error);
            }
        } catch (e) {
            showError('–û—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
    async function runDiagnostics() {
        const profile = document.getElementById('debugProfile').value;
        const problem = document.getElementById('debugProblem').value.trim();

        if (!problem) {
            alert('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É');
            return;
        }

        const btn = document.getElementById('diagBtn');
        btn.disabled = true;
        showLoading('Claude –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É... (–¥–æ 2 –º–∏–Ω)');

        try {
            const response = await fetch('/api/debug/diagnose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile, problem })
            });
            const data = await response.json();
            if (data.success) {
                showResult('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', data.response);
            } else {
                showError(data.error);
            }
        } catch (e) {
            showError('–û—à–∏–±–∫–∞: ' + e.message);
        }
        btn.disabled = false;
    }

    // –í–æ–ø—Ä–æ—Å –∫ Claude
    async function askQuestion() {
        const question = document.getElementById('question').value.trim();
        if (!question) {
            alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
            return;
        }

        const btn = document.getElementById('askBtn');
        btn.disabled = true;
        showLoading('Claude –¥—É–º–∞–µ—Ç... (–¥–æ 2 –º–∏–Ω)');

        try {
            const response = await fetch('/api/ai/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });
            const data = await response.json();
            if (data.success) {
                showResult('–û—Ç–≤–µ—Ç Claude', data.response);
            } else {
                showError(data.error);
            }
        } catch (e) {
            showError('–û—à–∏–±–∫–∞: ' + e.message);
        }
        btn.disabled = false;
    }

    // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    document.getElementById('debugProblem').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') runDiagnostics();
    });
    document.getElementById('question').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            askQuestion();
        }
    });
</script>
{% endblock %}
