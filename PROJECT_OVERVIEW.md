# Как работает VMMO Bot

## Главный цикл бота

### При запуске:
1. Загружаем настройки профиля (config.json)
2. Авторизуемся на сайте
3. Ремонтируем снаряжение
4. Проверяем buy-craft (если включён) - это покупка компонентов с аукциона
5. Проверяем обычный крафт
6. Один раз идём на арену (если включена)

### Основной цикл (крутится бесконечно):
```
1. КРАФТ - проверяем первым делом, всегда
2. Ивент-данжены (НГ и прочие) - проходим все доступные
3. Чистим рюкзак (если заполнен)
4. Собираем почту
5. Забираем ежедневные награды
6. Смотрим какие данжены доступны:
   - Если есть → проходим их по очереди
   - Если все на КД → идём в Шахту или Адские Игры
7. Повторяем
```

**ВАЖНО:** Перед КАЖДЫМ действием проверяем крафт. Это главный приоритет.

---

## Приоритеты

```
1. Крафт (всегда первый)
2. Арена (один раз в начале сессии)
3. Ивент-данжены (НГ, Сталкер и т.д.)
4. Обычные данжены
5. Шахта / Адские Игры (когда всё на КД)
```

---

## Крафт

### Две системы:

**Buy-Craft** (если включён):
- Смотрим что выгодно крафтить
- Покупаем компоненты на аукционе
- Крафтим
- Продаём готовое
- Профит

**Обычный крафт** (Iron Craft):
- Автовыбор рецепта (или ручной список)
- Крафтим бесконечно
- Когда накопили batch_size штук → продаём всё
- Повторяем

### Как работает автовыбор:
1. Смотрим кэш цен (обновляется раз в сутки)
2. Считаем сколько ботов на каждом рецепте
3. Выбираем рецепт где меньше всего ботов
4. Есть лимиты:
   - Платиновый слиток (13ч крафта) → максимум 2 бота
   - Торовый/Бронзовый слиток (2-4ч) → максимум 3 бота
   - Остальное → максимум 5 ботов

### Цепочки крафта:
```
Руда → Железо → Железный слиток
Медная руда → Медь → Бронза / Медный слиток
Руда → Платина → Платиновый слиток
Руда + Железо → Тор → Торовый слиток
Железо + Тор + Платина → Сумеречная сталь
```

### Статусы крафта:
- **in_progress** - крафтится, ждём
- **ready** - готов, забираем
- **free** - свободен, запускаем новый

---

## Данжены

### Вход:
1. Получаем список доступных данжей (без КД)
2. Фильтруем по настройкам (вкладки, скипы)
3. Заходим в данж
4. Выбираем сложность (brutal → hero → normal)
5. Жмём "Войти"
6. Бой

### Бой:
```
Каждую итерацию:
1. Metronome (heartbeat) каждые 1.5 сек - БЕЗ ЭТОГО ЛУТ НЕ ПРИХОДИТ!
2. Проверяем смерть
3. Проверяем есть ли враги
4. Если нет врагов → ищем кнопку "Продолжить" или "Выход"
5. Если GCD прошёл → используем скилл
6. Иначе → обычная атака
7. Каждые 3 атаки → собираем лут
```

### Сбор лута (критично!):
- Без metronome heartbeat лут вообще не приходит
- Лут собирается через refresher URL каждые 3 атаки
- Парсим dropLoot из ответа и забираем

### Смерти и сложность:
```
brutal → 1 смерть → hero
hero → 1 смерть → normal
normal → 1 смерть → skip (пропускаем этот данж)
```

Смерти записываются в deaths.json

---

## Ивент-данжены

### Текущие (НГ 2026):
- Логово Демона Мороза (brutal)
- Пещеры Сурта (normal)
- Предвестник Тьмы (brutal)
- Ледяная Цитадель (brutal)

### Логика:
1. Проверяем КД (кэшируется глобально)
2. Если доступен → заходим
3. Забираем награду если есть
4. Ищем кнопку входа
5. Бой (как обычно)
6. После победы → обновляем КД

### Печать Сталкера:
В ивент-боях ищем кнопку активации печати и жмём её.

---

## Арена

### Flow:
1. Проверяем сколько боёв осталось
2. Если мало → выходим
3. Жмём "В очередь"
4. Ждём матч (поллим каждые 3 сек)
5. Жмём "На арену"
6. Ждём 12 сек (предбой)
7. Бой
8. Результаты
9. Если проиграли → воскрешение + ремонт
10. Повторяем

---

## Рюкзак

### Когда чистим:
- Заполнен на 20+ из 28 слотов

### Логика очистки:
```
Для каждого предмета:
1. Защищённый? → пропускаем
2. Легендарный? → пропускаем
3. Можно на аукцион? → выставляем
4. Можно разобрать? → разбираем
5. Можно выкинуть? → выкидываем

Сундуки → открываем
```

### Защищённые предметы (не трогаем):
- Крафтовые: Железо, Медь, Платина, Руды, Слитки
- Квестовые: Печати Сталкера, Кристаллы
- Сундуки: Ларцы, Шкатулки (открываем, не продаём)

---

## Аукцион

### Продажа:
1. Смотрим кэш цен (чтобы боты не перебивали друг друга)
2. Если нет кэша → смотрим конкурентов
3. Ставим цену на 1 серебро ниже минимальной
4. Если нет конкурентов → дефолтная цена
5. Если неизвестный предмет → в чёрный список

### Чёрный список:
- Предметы без конкурентов и без дефолтной цены
- Предметы с очень низкой ценой
- Такие предметы разбираем, не продаём
- Список обновляется раз в 24 часа

---

## Почта

### Что делаем:
1. Ищем непрочитанные письма
2. Проверяем тип:
   - "Твоя продажа" → забираем деньги
   - "Срок лота истёк" → забираем предмет, добавляем в чёрный список
3. Удаляем письмо

### Интеграция с buy-craft:
- Если продался buy-craft предмет → запускаем новый цикл
- Если не продался → пробуем снова

---

## Адские Игры

Когда всё на КД → идём в Адские Игры на время крафта.
Как только крафт готов → выходим и проверяем.

---

## Шахта (Survival Mines)

### Настройки:
- max_wave - до какой волны доходить
- max_level - максимальный уровень шахты

Заходим когда данжены на КД.

---

## Важные нюансы

### Metronome (heartbeat)
```
Интервал: 1.5 сек
БЕЗ НЕГО ЛУТ НЕ ПРИХОДИТ ВООБЩЕ!
```

### Lock-файл
```
profiles/{char}/.lock = "PID|timestamp"
```
Защита от запуска двух ботов на одного персонажа.

### Watchdog
Если бот завис (40 попыток без прогресса) → перезапуск.

---

## Файлы

```
profiles/char1/
├── config.json      # Настройки персонажа
├── cookies.json     # Сессия (авторизация)
├── deaths.json      # Смерти и сложности данжей
├── status.json      # Текущая активность (для TG бота)
└── .lock            # Lock-файл процесса

auction_blacklist.json  # Чёрный список аукциона
auction_price_cache.json # Кэш цен (глобальный)
```

---

## Конфиг персонажа (основное)

```json
{
  "craft_mode": "iron|bronze|platinum|auto",
  "auto_select_craft": true,
  "is_arena_enabled": false,
  "is_event_dungeon_enabled": true,
  "is_ny_event_dungeon_enabled": true,
  "is_hell_games_enabled": true,
  "dungeon_tabs": ["tab2"],
  "skill_cooldowns": {1: 15.5, 2: 24.5, ...}
}
```
