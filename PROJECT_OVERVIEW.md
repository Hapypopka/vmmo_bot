# VMMO Bot - Техническая документация

> **Версия:** 2026-01-27
> **Статус:** Актуальная

---

## 1. Общая архитектура

### 1.1 Что это

VMMO Bot - автоматизация браузерной игры через HTTP-запросы (requests). Бот эмулирует действия игрока: проходит данжены, крафтит, торгует на аукционе, собирает награды.

### 1.2 Стек технологий

| Компонент | Технология |
|-----------|------------|
| HTTP клиент | `requests` + `BeautifulSoup` |
| Веб-панель | Flask + Jinja2 |
| Telegram бот | `python-telegram-bot` |
| База ресурсов | SQLite (resource_history.db) |
| Кэш цен | JSON файлы |
| Хостинг | VPS Нидерланды (45.131.187.128) |

### 1.3 Структура модулей (40 файлов)

```
requests_bot/
├── bot.py              # Главный цикл, оркестратор
├── client.py           # HTTP клиент (requests wrapper)
├── config.py           # Конфигурация профилей
├── logger.py           # Логирование
├── watchdog.py         # Защита от зависаний
│
├── combat.py           # Парсинг боя, скиллы, сбор лута
├── run_dungeon.py      # Прохождение данжей
├── arena.py            # PvP арена
│
├── craft.py            # Циклический крафт (IronCraft)
├── craft/              # Подмодули крафта
│   ├── recipes.py      # Рецепты и цепочки
│   ├── quotas.py       # Распределение ботов по рецептам
│   ├── prices.py       # Кэш цен аукциона
│   └── distribution.py # Локи и координация
│
├── event_dungeon.py    # Ивент-данжены (НГ и др.)
├── hell_games.py       # Адские Игры
├── survival_mines.py   # Заброшенная Шахта
│
├── backpack.py         # Управление рюкзаком
├── auction.py          # Работа с аукционом
├── mail.py             # Сбор почты
├── daily_rewards.py    # Ежедневные награды
│
├── pets.py             # Воскрешение питомцев
├── popups.py           # Обработка попапов
├── resources.py        # Парсинг ресурсов
├── resource_history.py # История ресурсов (SQLite)
├── stats.py            # Статистика сессий
│
├── sell_resources.py   # Продажа ресурсов
├── sell_crafts.py      # Продажа крафтовых предметов
│
├── telegram_bot.py     # Telegram управление
├── web_panel.py        # Веб-панель (Flask)
│
├── create_character.py # Создание персонажа
├── tutorial.py         # Прохождение туториала
└── gold_transfer.py    # Передача золота
```

---

## 2. Главный цикл бота

### 2.1 Запуск (bot.py → login())

```
1. Загрузка профиля (config.json)
2. Загрузка cookies
3. Проверка авторизации
4. Инициализация клиентов (DungeonRunner, CraftClient, etc.)
5. Ремонт снаряжения
6. reset_session_time() ← ВАЖНО: сброс времени сессии
7. Парсинг ресурсов из рюкзака
8. check_craft() ← первая проверка крафта
9. Один раз: Арена (если включена)
```

### 2.2 Основной цикл (run_dungeon_cycle)

```
┌─────────────────────────────────────────────────────┐
│  ЦИКЛ (бесконечный)                                 │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. check_craft()         ← Крафт ВСЕГДА первый    │
│                                                     │
│  2. Ивент-данжены         ← Если включены          │
│     └─ try_ny_event_dungeon_method()               │
│                                                     │
│  3. Очистка рюкзака       ← Если > 18 предметов    │
│     ├─ Открыть сундуки                             │
│     ├─ Продать на аукцион                          │
│     ├─ Разобрать лишнее                            │
│     └─ Продать ресурсы (если включено)             │
│                                                     │
│  4. Сбор почты                                      │
│                                                     │
│  5. Ежедневные награды    ← Раз в сутки            │
│                                                     │
│  6. Данжены               ← Основная активность    │
│     ├─ Получить список доступных                   │
│     ├─ Для каждого: check_craft() + бой            │
│     └─ После боя: очистка рюкзака                  │
│                                                     │
│  7. Если всё на КД:                                │
│     ├─ Шахта (если включена)                       │
│     └─ Адские Игры (если включены)                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2.3 Приоритеты (в порядке убывания)

| # | Активность | Частота проверки |
|---|------------|------------------|
| 1 | **Крафт** | Перед КАЖДЫМ действием |
| 2 | Арена | Один раз при старте |
| 3 | Ивент-данжены | Каждый цикл |
| 4 | Обычные данжены | Каждый цикл |
| 5 | Шахта / Адские Игры | Когда данжены на КД |

---

## 3. Система крафта

### 3.1 Архитектура

```
craft.py
├── IronCraftClient      # Базовый класс
│   ├── check_craft()    # Проверка статуса
│   ├── collect_craft()  # Забор готового
│   └── start_craft()    # Запуск нового
│
└── CyclicCraftClient    # Расширенный класс
    ├── do_cyclic_craft_step()  # Один шаг цикла
    ├── _auto_select_recipe()   # Автовыбор рецепта
    └── _sell_batch()           # Продажа партии
```

### 3.2 Режимы работы

**craft_mode** в конфиге определяет базовый режим:
- `iron` - крафт железа
- `bronze` - крафт бронзы
- `copperBar` - крафт медного слитка
- `auto` - автоматический выбор

**craft_items** - очередь крафта:
```json
{
  "craft_items": [
    {"item": "bronzeBar", "batch_size": 1},
    {"item": "platinum", "batch_size": 2}
  ]
}
```

### 3.3 Цепочки рецептов

```
Уровень 1 (start_url):
  rawOre (30с)    → iron (60с)
  copperOre (120с) → copper (180с)

Уровень 2 (CAP_craftReceipt):
  iron → ironBar (60м)
  copper → copperBar (120м)
  copper → bronze (30м)

Уровень 3:
  bronze → bronzeBar (240м)
  iron → platinum (60м)
  platinum → platinumBar (780м)
  iron → thor (60м)
  thor → thorBar (240м)

Уровень 4:
  thor + platinum → twilightSteel (1440м)
```

### 3.4 Автовыбор рецепта

1. Загрузить кэш цен (обновляется раз в 24ч)
2. Посчитать сколько ботов на каждом рецепте
3. Выбрать рецепт с минимумом ботов
4. Лимиты:
   - Платиновый слиток (13ч): макс 2 бота
   - Торовый/Бронзовый (2-4ч): макс 3 бота
   - Остальное: макс 5 ботов

### 3.5 Статусы крафта

| Статус | Описание | Действие |
|--------|----------|----------|
| `in_progress` | Крафтится | Ждать |
| `ready` | Готов | Забрать |
| `free` | Свободен | Запустить |

---

## 4. Система боя

### 4.1 Компоненты

```
combat.py
├── CombatParser       # Парсинг HTML
│   ├── parse_enemies()
│   ├── parse_skills()
│   └── extract_wicket_urls()
│
└── CombatClient       # Выполнение действий
    ├── attack()
    ├── use_skill()
    └── collect_loot()
```

### 4.2 Константы боя

```python
ENEMY_POSITIONS = [21, 22, 23, 24, 25]  # Позиции врагов
SKILL_POSITIONS = [1, 2, 3, 4, 5]       # Позиции скиллов
GCD = 2.0                               # Глобальный КД (сек)
ATTACK_CD = 0.6                         # КД автоатаки
ACTION_LIMIT = 500                      # Лимит действий в данже
```

### 4.3 Алгоритм боя

```
Каждую итерацию:
1. Отправить metronome (heartbeat) ← КРИТИЧНО для лута!
2. Проверить смерть персонажа
3. Найти живых врагов
4. Если врагов нет → искать "Продолжить"/"Выход"
5. Если GCD прошёл → использовать скилл
6. Иначе → обычная атака
7. Каждые 3 атаки → refresher (сбор лута)
```

### 4.4 Сбор лута (критично!)

**Metronome heartbeat** - без него лут не приходит вообще!
- Интервал: 1.5 сек
- URL: `/dungeon/combat/XXX?pageId-IEndpointBehaviorListener.1-...`

**Refresher** - сбор выпавшего лута:
- Каждые 3 атаки
- URL: `/dungeon/combat/XXX?pageId-1.IBehaviorListener.0-...-refresher`

### 4.5 Смерти и сложность

```
brutal → 1 смерть → hero
hero   → 1 смерть → normal
normal → 1 смерть → skip (пропуск данжа)
```

Хранится в `profiles/<char>/deaths.json`

---

## 5. Ивент-данжены

### 5.1 Текущие (НГ 2026)

| ID | Название | Сложность |
|----|----------|-----------|
| NYLairFrost_2026 | Логово Демона Мороза | brutal |
| SurtCaves | Пещеры Сурта | normal |
| DarknessComing | Предвестник Тьмы | brutal |
| NYIceCastle_2026 | Ледяная Цитадель | brutal |

### 5.2 Логика

1. Проверить КД (кэшируется глобально)
2. Забрать награду если есть
3. Найти кнопку входа
4. Бой (стандартный алгоритм)
5. После победы → обновить КД

---

## 6. Рюкзак и Аукцион

### 6.1 Очистка рюкзака

Триггер: > 18 предметов из 28

```
Для каждого предмета:
1. Защищённый? → ПРОПУСТИТЬ
2. Легендарный? → ПРОПУСТИТЬ
3. Сундук? → ОТКРЫТЬ
4. Можно продать? → АУКЦИОН
5. Можно разобрать? → РАЗОБРАТЬ
```

### 6.2 Защищённые предметы

Не продаются и не разбираются:
- **Крафт:** Железо, Медь, Платина, Руды, Слитки
- **Квест:** Печати Сталкера, Кристаллы Тикуана
- **Ресурсы:** Ледяной Кристалл, Уголь Эфирного Древа
- **Экип:** Шлем Нордов

### 6.3 Ценообразование на аукционе

1. Проверить кэш цен
2. Если нет → посмотреть конкурентов
3. Цена = минимальная - 1 серебро
4. Если нет конкурентов → дефолтная цена
5. Если неизвестный → в чёрный список

### 6.4 Продажа ресурсов

Настраивается в `resource_sell`:
```json
{
  "mineral": {"enabled": true, "reserve": 9500, "stack": 1000},
  "skull": {"enabled": true, "reserve": 100, "stack": 1000},
  "sapphire": {"enabled": true, "reserve": 7500, "stack": 100},
  "ruby": {"enabled": true, "reserve": 300, "stack": 100}
}
```

---

## 7. Конфигурация

### 7.1 Структура профиля

```
profiles/<char>/
├── config.json          # Настройки персонажа
├── cookies.json         # Сессия авторизации
├── deaths.json          # Смерти и сложности
├── status.json          # Текущая активность
├── resources.json       # Ресурсы и сессия
├── resource_history.db  # История (SQLite)
├── stats.json           # Статистика
├── craft_inventory.json # Инвентарь крафта
└── .lock                # Lock-файл процесса
```

### 7.2 Основные настройки (config.json)

| Параметр | Тип | Описание |
|----------|-----|----------|
| `username` | string | Логин |
| `password` | string | Пароль |
| `name` | string | Отображаемое имя |
| `dungeons_enabled` | bool | Включить данжены |
| `dungeon_tabs` | array | Вкладки данжей ["tab2", "tab3"] |
| `only_dungeons` | array | Список разрешённых данжей |
| `skip_dungeons` | array | Список пропускаемых |
| `iron_craft_enabled` | bool | Включить крафт |
| `craft_mode` | string | Режим крафта |
| `craft_items` | array | Очередь крафта |
| `craft_finish_time` | int | Timestamp окончания крафта |
| `arena_enabled` | bool | Включить арену |
| `arena_max_fights` | int | Макс. боёв на арене |
| `hell_games_enabled` | bool | Включить Адские Игры |
| `ny_event_dungeon_enabled` | bool | Ивент-данжены НГ |
| `daily_rewards_enabled` | bool | Ежедневные награды |
| `skill_cooldowns` | object | КД скиллов {1: 15.5, ...} |
| `skill_hp_threshold` | object | HP порог для скилла {2: 20000} |
| `resource_sell` | object | Настройки продажи ресурсов |

### 7.3 Глобальные файлы

| Файл | Описание |
|------|----------|
| `protected_items.json` | Защищённые предметы |
| `auction_blacklist.json` | Чёрный список аукциона |
| `settings.json` | Глобальные настройки |

---

## 8. Технические детали

### 8.1 Wicket AJAX Framework

Игра использует Apache Wicket. URL'ы извлекаются через regex:
```python
r'Wicket\.Ajax\.ajax\(\{[^}]*"c":"([^"]+)"[^}]*"u":"([^"]+)"'
```

Заголовки для AJAX запросов:
```
Wicket-Ajax: true
Wicket-Ajax-BaseURL: ...
X-Requested-With: XMLHttpRequest
```

### 8.2 Lock-файл

```
profiles/<char>/.lock = "PID|timestamp"
```
Защита от запуска двух ботов на одного персонажа.

### 8.3 Watchdog

Если бот завис (40+ попыток без прогресса) → принудительный выход из данжа.

### 8.4 Сервер и деплой

```bash
# SSH подключение
ssh -i ~/.ssh/id_ed25519_vmmo root@45.131.187.128

# Деплой файла
scp -i ~/.ssh/id_ed25519_vmmo file.py root@45.131.187.128:/home/claude/vmmo_bot/requests_bot/

# Очистка кэша
rm -rf /home/claude/vmmo_bot/requests_bot/__pycache__/
```

---

## 9. Интерфейсы управления

### 9.1 Веб-панель

**URL:** https://faizbot.duckdns.org
**Пароль:** 1616

Функции:
- Запуск/остановка ботов
- Настройка профилей
- Просмотр логов и статистики
- Управление защищёнными предметами

### 9.2 Telegram бот

Команды управления через inline-кнопки:
- Запуск/стоп ботов
- Перезапуск
- Просмотр статуса

---

## 10. Найденные проблемы

### 10.1 КРИТИЧНЫЕ

| # | Проблема | Файл | Описание |
|---|----------|------|----------|
| ~~1~~ | ~~**Избыточные проверки крафта**~~ | ~~bot.py~~ | ✅ **НЕ ПРОБЛЕМА** - `check_craft()` оптимизирован: читает из памяти, выходит рано если крафт идёт, HTTP только когда готов |
| ~~2~~ | ~~**Глобальное состояние конфига**~~ | ~~config.py~~ | ✅ **НЕ ПРОБЛЕМА** - Каждый бот отдельный процесс, нет race condition. Синхронизация с диском добавлена для craft_items |
| ~~3~~ | ~~**Хрупкие URL через regex**~~ | ~~везде~~ | ⚠️ **ОГРАНИЧЕНИЕ** - Особенность Apache Wicket: URL динамические, требуют парсинга. Не исправимо без изменения игры |

### 10.2 СРЕДНИЕ

| # | Проблема | Файл | Описание |
|---|----------|------|----------|
| ~~4~~ | ~~**Фрагментация сбора лута**~~ | ~~run_dungeon.py~~ | ✅ **УПРОЩЕНО** - Удалены 2 неиспользуемых метода, оставлен только refresher |
| ~~5~~ | ~~**Жизненный цикл CraftClient**~~ | ~~craft.py~~ | ✅ **ИСПРАВЛЕНО** - Рецепт обновляется при изменении craft_items через веб-панель |
| ~~6~~ | ~~**Смешанная конфигурация**~~ | ~~config.py~~ | ⚠️ **ПО ДИЗАЙНУ** - settings.json = глобальные, profiles/*/config.json = персональные |
| ~~7~~ | ~~**Неполное восстановление**~~ | ~~bot.py~~ | ✅ **ИСПРАВЛЕНО** - Hell Games теперь воскрешает после смерти |

### 10.3 НЕЗНАЧИТЕЛЬНЫЕ

| # | Проблема | Файл | Описание |
|---|----------|------|----------|
| ~~8~~ | ~~**Мёртвый код**~~ | ~~backpack.py~~ | ✅ **УДАЛЕНО** - `repeat_craft_if_ready()`, `check_craft_ready()` |
| ~~9~~ | ~~**Мёртвый код**~~ | ~~bot.py~~ | ✅ **УДАЛЕНО** - `try_event_dungeon()`, `try_restart_craft()` |
| ~~10~~ | ~~**Мёртвый код**~~ | ~~craft.py~~ | ✅ **УДАЛЕНО** - `run_cycle()`, `run_full_cycle()`, `run_smart_cycle()` и др. |
| ~~11~~ | ~~**Magic numbers**~~ | ~~везде~~ | ✅ **ИСПРАВЛЕНО** - Вынесены в config.py: `GCD`, `ATTACK_CD`, `LOOT_COLLECT_INTERVAL` |
| ~~12~~ | ~~**Импорты**~~ | ~~bot.py~~ | ⚠️ **КОСМЕТИКА** - Импорты организованы по модулям, работают нормально |

### 10.4 Архитектурные долги

1. **Нет тестов** - ни unit, ни интеграционных
2. **Нет типизации** - Python без type hints
3. **Логирование непоследовательное** - где-то log_info, где-то print()
4. **Конфиг persistence** - craft_finish_time сохраняется в конфиг вместо отдельного файла

---

## 11. Рекомендации по улучшению

| Приоритет | Что | Статус |
|-----------|-----|--------|
| ~~HIGH~~ | ~~Кэшировать craft_finish_time~~ | ✅ Уже кэшируется в памяти (`_profile_config`) |
| ~~HIGH~~ | ~~Убрать глобальное состояние~~ | ⚠️ Не нужно - каждый бот отдельный процесс |
| LOW | Централизовать URL-билдинг | Ограничение Wicket - URL динамические |
| ~~MEDIUM~~ | ~~Унифицировать сбор лута~~ | ✅ **СДЕЛАНО** - оставлен только refresher |
| LOW | Документировать автосохранение | Низкий приоритет |
| ~~LOW~~ | ~~Удалить мёртвый код~~ | ✅ **СДЕЛАНО** - удалено ~460 строк |
| LOW | Добавить type hints | Низкий приоритет, работает без них |

---

*Документ актуализирован: 2026-01-27*
*Исправлены/проверены проблемы: #1-11 (все)*
